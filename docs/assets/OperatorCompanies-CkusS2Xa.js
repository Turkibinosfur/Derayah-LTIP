import{a as H,u as J,s as i,j as e}from"./index-DDk1oefv.js";import{r as a,u as K}from"./react-vendor-xiFAdxLt.js";import{g as A,r as U,p as q,c as Q,U as D,F as Y,b as Z,z as R,X as ee,s as te}from"./ui-vendor-B0ZOy8uN.js";import"./supabase-vendor-B-LuImWU.js";function oe(){const{t:s,i18n:V}=H();V.language;const[n,L]=a.useState([]),[T,u]=a.useState(!0),[b,h]=a.useState(null),[d,j]=a.useState(null),[$,y]=a.useState(!1),[v,N]=a.useState("active"),[w,C]=a.useState("pending"),[_,S]=a.useState(!1),[E,c]=a.useState(null),{userRole:l,setActiveCompany:F,isSuperAdmin:k}=J(),I=K(),g=a.useMemo(()=>k()||(l==null?void 0:l.user_type)==="super_admin"||(l==null?void 0:l.role)==="super_admin",[l,k]);a.useEffect(()=>{if(!g){h(s("operatorConsole.accessDenied")),u(!1);return}M()},[g]);const M=async()=>{try{u(!0),h(null);const{data:t,error:r}=await i.from("companies").select("*").order("created_at",{ascending:!1});if(r)throw r;const x=await Promise.all((t||[]).map(async o=>{const{count:m}=await i.from("employees").select("*",{count:"exact",head:!0}).eq("company_id",o.id),{count:p}=await i.from("incentive_plans").select("*",{count:"exact",head:!0}).eq("company_id",o.id),{count:P}=await i.from("grants").select("*",{count:"exact",head:!0}).eq("company_id",o.id),{count:W}=await i.from("company_users").select("*",{count:"exact",head:!0}).eq("company_id",o.id).eq("is_active",!0);return{...o,employee_count:m||0,plan_count:p||0,grant_count:P||0,admin_user_count:W||0}}));L(x)}catch(t){console.error("Error loading companies:",t),h(s("operatorConsole.failedToLoad"))}finally{u(!1)}},O=t=>{j(t),N(t.status),C(t.verification_status),c(null),y(!0)},f=()=>{j(null),c(null),y(!1)},z=async()=>{if(d)try{S(!0),c(null);const{error:t}=await i.from("companies").update({status:v,verification_status:w,updated_at:new Date().toISOString()}).eq("id",d.id);if(t){console.error("Error updating company:",t),c(`Failed to save changes: ${t.message}`);return}f(),await M()}catch(t){console.error("Error updating company:",t),c(`Failed to save changes: ${(t==null?void 0:t.message)||"Unknown error occurred"}`)}finally{S(!1)}},B=(t,r)=>{F(t,r),I("/dashboard")},X=t=>({pending:{label:s("operatorConsole.pending"),color:"bg-yellow-50 text-yellow-700 border-yellow-200",icon:q},verified:{label:s("operatorConsole.verified"),color:"bg-green-50 text-green-700 border-green-200",icon:U},rejected:{label:s("operatorConsole.rejected"),color:"bg-red-50 text-red-700 border-red-200",icon:te}})[t],G=t=>({active:{label:"Active",color:"bg-green-50 text-green-700"},suspended:{label:s("operatorConsole.suspended"),color:"bg-yellow-50 text-yellow-700"},inactive:{label:s("operatorConsole.inactive"),color:"bg-gray-100 text-gray-500"}})[t];return g?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:s("operatorConsole.title")}),e.jsx("p",{className:"text-gray-600 mt-1",children:s("operatorConsole.description")})]})}),b&&e.jsx("div",{className:"p-4 rounded-lg border border-red-200 bg-red-50 text-red-700",children:b}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:s("operatorConsole.totalCompanies")}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:n.length})]}),e.jsx(A,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:s("operatorConsole.verified")}),e.jsx("p",{className:"text-2xl font-bold text-green-600 mt-1",children:n.filter(t=>t.verification_status==="verified").length})]}),e.jsx(U,{className:"w-8 h-8 text-green-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:s("operatorConsole.pending")}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600 mt-1",children:n.filter(t=>t.verification_status==="pending").length})]}),e.jsx(q,{className:"w-8 h-8 text-yellow-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:s("operatorConsole.active")}),e.jsx("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:n.filter(t=>t.status==="active").length})]}),e.jsx(Q,{className:"w-8 h-8 text-blue-600"})]})})]}),T?e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-12 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:s("operatorConsole.loadingCompanies")})]}):e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(A,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:s("operatorConsole.allCompanies")}),e.jsx("p",{className:"text-sm text-gray-500",children:s("operatorConsole.manageCompanies")})]})]})}),n.length===0?e.jsx("div",{className:"p-10 text-center text-gray-500",children:s("operatorConsole.noCompanies")}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:s("operatorConsole.company")}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:s("operatorConsole.tadawulSymbol")}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:s("operatorConsole.verification")}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:s("operatorConsole.status")}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:s("operatorConsole.statistics")}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:s("operatorConsole.shares")}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:s("operatorConsole.created")}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:s("operatorConsole.actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:n.map(t=>{var m,p;const r=X(t.verification_status),x=G(t.status),o=r.icon;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.company_name_en}),e.jsx("div",{className:"text-sm text-gray-500",dir:"rtl",children:t.company_name_ar}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["CR: ",t.commercial_registration_number]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700",children:t.tadawul_symbol})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${r.color}`,children:[e.jsx(o,{className:"w-3 h-3 mr-1"}),r.label]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${x.color}`,children:x.label})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs",children:[e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(D,{className:"w-3 h-3 mr-1"}),t.employee_count||0]}),e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(Y,{className:"w-3 h-3 mr-1"}),t.plan_count||0]}),e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(Z,{className:"w-3 h-3 mr-1"}),t.grant_count||0]}),e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(D,{className:"w-3 h-3 mr-1"}),t.admin_user_count||0," admins"]})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[e.jsxs("div",{children:["Total: ",((m=t.total_reserved_shares)==null?void 0:m.toLocaleString())||0]}),e.jsxs("div",{className:"text-xs",children:["Available: ",((p=t.available_shares)==null?void 0:p.toLocaleString())||0]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(t.created_at).toLocaleDateString("en-GB")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>B(t.id,t.company_name_en),className:"px-3 py-1 text-xs font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition",children:"View"}),e.jsx("button",{onClick:()=>O(t),className:"p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":`Actions for ${t.company_name_en}`,children:e.jsx(R,{className:"w-5 h-5 text-gray-500"})})]})})]},t.id)})})]})})]}),$&&d&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Company"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Update verification and status for ",d.company_name_en]})]}),e.jsx("button",{onClick:f,className:"text-gray-400 hover:text-gray-600","aria-label":"Close edit modal",children:e.jsx(ee,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-5 space-y-5",children:[E&&e.jsx("div",{className:"p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 text-sm",children:E}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:s("operatorConsole.verificationStatus")}),e.jsxs("select",{value:w,onChange:t=>C(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"pending",children:s("operatorConsole.pending")}),e.jsx("option",{value:"verified",children:s("operatorConsole.verified")}),e.jsx("option",{value:"rejected",children:s("operatorConsole.rejected")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:s("operatorConsole.companyStatus")}),e.jsxs("select",{value:v,onChange:t=>N(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"active",children:s("operatorConsole.active")}),e.jsx("option",{value:"suspended",children:s("operatorConsole.suspended")}),e.jsx("option",{value:"inactive",children:s("operatorConsole.inactive")})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsx("button",{onClick:f,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800",type:"button",children:"Cancel"}),e.jsx("button",{onClick:z,disabled:_,className:"px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",type:"button",children:s(_?"common.loading":"operatorConsole.saveChanges")})]})]})})]}):e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-700",children:s("operatorConsole.accessDenied")})})})}export{oe as default};
