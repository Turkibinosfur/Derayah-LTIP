import{a as O,b as V,s as p,j as e}from"./index-CHcuUdej.js";import{r as d,a as Y}from"./react-vendor-xiFAdxLt.js";import{x as q,T as F,E as Q,J as X,N as Z,U as ee,c as te,D as re}from"./ui-vendor-a8g5-7pO.js";import"./supabase-vendor-B-LuImWU.js";function oe(){const{t:s,i18n:G}=O(),x=G.language==="ar",{brandColor:o}=V(),[_,z]=d.useState([]),[R,A]=d.useState(!0),[W,y]=d.useState(!1),[C,w]=d.useState(null),[N,E]=d.useState("create"),[$,g]=d.useState(null),[b,f]=d.useState(null),[v,h]=d.useState(null),[a,u]=d.useState({name:"",description:"",metric_type:"operational",unit_of_measure:""});d.useEffect(()=>{M()},[]),d.useEffect(()=>{if(!b)return;const t=r=>{if(r instanceof KeyboardEvent){r.key==="Escape"&&(f(null),h(null));return}f(null),h(null)};return document.addEventListener("click",t),document.addEventListener("touchstart",t),document.addEventListener("keydown",t),window.addEventListener("resize",t),window.addEventListener("scroll",t,!0),()=>{document.removeEventListener("click",t),document.removeEventListener("touchstart",t),document.removeEventListener("keydown",t),window.removeEventListener("resize",t),window.removeEventListener("scroll",t,!0)}},[b]);const M=async()=>{try{const{data:{user:t}}=await p.auth.getUser();if(!t)return;const{data:r}=await p.from("company_users").select("company_id").eq("user_id",t.id).single();if(!r)return;const{data:i}=await p.from("performance_metrics").select(`
          *,
          grant_performance_metrics (
            grant_id,
            grants (
              id,
              grant_number,
              incentive_plans (plan_name_en, plan_code),
              employees (first_name_en, last_name_en)
            )
          )
        `).eq("company_id",r.company_id).order("created_at",{ascending:!1});if(i){const n=i.map(c=>({id:c.id,company_id:c.company_id,name:c.name,description:c.description,metric_type:c.metric_type,unit_of_measure:c.unit_of_measure,created_at:c.created_at,linkedGrants:(c.grant_performance_metrics||[]).map(l=>{var m,j,L,S,D,P,U;return{id:(m=l.grants)==null?void 0:m.id,grant_number:((j=l.grants)==null?void 0:j.grant_number)||"Grant",employee_name:(L=l.grants)!=null&&L.employees?`${l.grants.employees.first_name_en} ${l.grants.employees.last_name_en}`:"Employee",plan_name_en:((D=(S=l.grants)==null?void 0:S.incentive_plans)==null?void 0:D.plan_name_en)||null,plan_code:((U=(P=l.grants)==null?void 0:P.incentive_plans)==null?void 0:U.plan_code)||null}})}));z(n)}}catch(t){console.error("Error loading metrics:",t)}finally{A(!1)}},H=async()=>{try{const{data:{user:t}}=await p.auth.getUser();if(!t)return;const{data:r}=await p.from("company_users").select("company_id").eq("user_id",t.id).single();if(!r)return;let i=$;if(N==="create"){const{data:n,error:c}=await p.from("performance_metrics").insert({company_id:r.company_id,name:a.name,description:a.description,metric_type:a.metric_type,unit_of_measure:a.unit_of_measure}).select().single();if(c)throw c;i=(n==null?void 0:n.id)||null}else if(i){const{error:n}=await p.from("performance_metrics").update({name:a.name,description:a.description,metric_type:a.metric_type,unit_of_measure:a.unit_of_measure}).eq("id",i).eq("company_id",r.company_id);if(n)throw n}if(!i)throw new Error("Failed to determine performance metric ID");y(!1),k(),g(null),M()}catch(t){console.error("Error saving performance metric:",t),alert("Failed to save performance metric")}},B=async t=>{try{const{error:r}=await p.from("performance_metrics").delete().eq("id",t);if(r)throw r;w(null),$===t&&g(null),M()}catch(r){console.error("Error deleting metric:",r),alert("Failed to delete performance metric")}},k=()=>{u({name:"",description:"",metric_type:"operational",unit_of_measure:""})},J=t=>{switch(t){case"financial":return e.jsx(re,{className:"w-5 h-5"});case"operational":return e.jsx(te,{className:"w-5 h-5"});case"personal":return e.jsx(ee,{className:"w-5 h-5"});default:return e.jsx(F,{className:"w-5 h-5"})}},T=t=>{switch(t){case"financial":return"bg-green-100 text-green-800";case"operational":return"bg-blue-100 text-blue-800";case"personal":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}},I=()=>{E("create"),g(null),k(),y(!0)},K=t=>{E("edit"),g(t.id),u({name:t.name,description:t.description||"",metric_type:t.metric_type,unit_of_measure:t.unit_of_measure}),y(!0)};return R?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"text-gray-500",children:"Loading performance metrics..."})}):e.jsxs("div",{className:`space-y-6 ${x?"text-right":"text-left"}`,dir:x?"rtl":"ltr",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:x?"text-right":"",children:[e.jsxs("h1",{className:`text-2xl font-bold text-gray-900 flex items-center gap-3 ${x?"flex-row-reverse justify-end":""}`,children:[s("performanceMetrics.title"),e.jsx("span",{className:"inline-flex items-center justify-center w-10 h-10 rounded-full text-white text-lg font-semibold",style:{backgroundColor:o},children:_.length})]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Define metrics for performance-based vesting"})]}),e.jsxs("button",{onClick:I,className:`flex items-center space-x-2 px-4 py-2 text-white rounded-lg transition ${x?"space-x-reverse":""}`,style:{backgroundColor:o},onMouseEnter:t=>{const r=parseInt(o.slice(1,3),16)*.9,i=parseInt(o.slice(3,5),16)*.9,n=parseInt(o.slice(5,7),16)*.9;t.currentTarget.style.backgroundColor=`rgb(${Math.round(r)}, ${Math.round(i)}, ${Math.round(n)})`},onMouseLeave:t=>{t.currentTarget.style.backgroundColor=o},children:[e.jsx(q,{className:"w-4 h-4"}),e.jsx("span",{children:s("performanceMetrics.addMetric")})]})]}),_.length===0?e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-12 text-center",children:[e.jsx(F,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:s("performanceMetrics.noMetricsYet")}),e.jsx("p",{className:"text-gray-600 mb-6",children:s("performanceMetrics.createFirstMetric")}),e.jsxs("button",{onClick:I,className:"inline-flex items-center space-x-2 px-4 py-2 text-white rounded-lg transition",style:{backgroundColor:o},onMouseEnter:t=>{const r=parseInt(o.slice(1,3),16)*.9,i=parseInt(o.slice(3,5),16)*.9,n=parseInt(o.slice(5,7),16)*.9;t.currentTarget.style.backgroundColor=`rgb(${Math.round(r)}, ${Math.round(i)}, ${Math.round(n)})`},onMouseLeave:t=>{t.currentTarget.style.backgroundColor=o},children:[e.jsx(q,{className:"w-4 h-4"}),e.jsx("span",{children:s("performanceMetrics.addMetric")})]})]}):e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:s("performanceMetrics.metric")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:s("performanceMetrics.type")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:s("performanceMetrics.unit")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:s("performanceMetrics.descriptionLabel")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:s("performanceMetrics.linkedGrants")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:s("performanceMetrics.created")}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide",children:s("performanceMetrics.actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:_.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 transition",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${T(t.metric_type)}`,children:J(t.metric_type)}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:t.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:["ID: ",t.id.slice(0,8),"..."]})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${T(t.metric_type)}`,children:t.metric_type})}),e.jsx("td",{className:"px-6 py-4 text-sm font-medium text-gray-900",children:t.unit_of_measure}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:t.description?e.jsx("span",{className:"block max-w-md break-words",children:t.description}):e.jsx("span",{className:"text-xs text-gray-400",children:s("performanceMetrics.noDescription")})}),e.jsx("td",{className:"px-6 py-4",children:t.linkedGrants.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:t.linkedGrants.map(r=>e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-medium",title:`${r.employee_name}${r.plan_name_en?` â€¢ ${r.plan_name_en}`:""}`,children:r.grant_number},`${t.id}-${r.id||r.grant_number}`))}):e.jsx("span",{className:"text-xs text-gray-400",children:s("performanceMetrics.none")})}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:new Date(t.created_at).toLocaleDateString()}),e.jsxs("td",{className:"px-6 py-4 text-right",children:[e.jsx("button",{onClick:r=>{r.stopPropagation();const i=r.currentTarget.getBoundingClientRect(),n=176,c=112;let l=i.bottom+8,m=i.right-n;l+c>window.innerHeight&&(l=i.top-c-8),l<8&&(l=8),m+n>window.innerWidth&&(m=window.innerWidth-n-8),m<8&&(m=8),h({top:l,left:m}),f(j=>j===t.id?null:t.id)},onTouchStart:r=>r.stopPropagation(),className:"p-2 rounded-full hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition","aria-haspopup":"true","aria-expanded":b===t.id,"aria-label":"Metric actions",children:e.jsx(Q,{className:"w-5 h-5"})}),b===t.id&&v&&Y.createPortal(e.jsxs("div",{className:"fixed z-50 w-44 origin-top-right rounded-lg border border-gray-200 bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none",role:"menu","aria-orientation":"vertical",style:{top:v.top,left:v.left},onClick:r=>{r.stopPropagation()},onTouchStart:r=>r.stopPropagation(),children:[e.jsxs("button",{onClick:()=>{f(null),h(null),K(t)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2 transition",role:"menuitem",children:[e.jsx(X,{className:"w-4 h-4 text-blue-500"}),"Edit metric"]}),e.jsxs("button",{onClick:()=>{f(null),h(null),w(t.id)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition",role:"menuitem",children:[e.jsx(Z,{className:"w-4 h-4"}),"Delete metric"]})]}),document.body)]})]},t.id))})]})})}),W&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-2xl w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:s(N==="create"?"performanceMetrics.addPerformanceMetric":"performanceMetrics.editPerformanceMetric")})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Metric Name"}),e.jsx("input",{type:"text",value:a.name,onChange:t=>u({...a,name:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"e.g., Annual Revenue Target"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Description"}),e.jsx("textarea",{value:a.description,onChange:t=>u({...a,description:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,placeholder:s("performanceMetrics.descriptionPlaceholder")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Metric Type"}),e.jsxs("select",{value:a.metric_type,onChange:t=>u({...a,metric_type:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"financial",children:s("performanceMetrics.financial")}),e.jsx("option",{value:"operational",children:s("performanceMetrics.operational")}),e.jsx("option",{value:"personal",children:s("performanceMetrics.personal")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit of Measure"}),e.jsx("input",{type:"text",value:a.unit_of_measure,onChange:t=>u({...a,unit_of_measure:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"e.g., SAR, users, %"})]})]}),e.jsx("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600",children:"Grant linkage for performance metrics is now managed from the Grants page when issuing or editing a grant."})]}),e.jsxs("div",{className:"p-6 border-t border-gray-200 flex items-center justify-end space-x-3",children:[e.jsx("button",{onClick:()=>{y(!1),k(),g(null)},className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{onClick:H,disabled:!a.name||!a.unit_of_measure,className:"px-6 py-2 text-white rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed",style:{backgroundColor:o},onMouseEnter:t=>{if(!t.currentTarget.disabled){const r=parseInt(o.slice(1,3),16)*.9,i=parseInt(o.slice(3,5),16)*.9,n=parseInt(o.slice(5,7),16)*.9;t.currentTarget.style.backgroundColor=`rgb(${Math.round(r)}, ${Math.round(i)}, ${Math.round(n)})`}},onMouseLeave:t=>{t.currentTarget.style.backgroundColor=o},children:s(N==="create"?"performanceMetrics.addMetric":"performanceMetrics.saveChanges")})]})]})}),C&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:s("performanceMetrics.deletePerformanceMetric")}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this metric? This action cannot be undone."}),e.jsxs("div",{className:"flex items-center justify-end space-x-3",children:[e.jsx("button",{onClick:()=>w(null),className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{onClick:()=>B(C),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition",children:"Delete"})]})]})})]})}export{oe as default};
