import{s as m,j as e}from"./index-DDk1oefv.js";import{r as p}from"./react-vendor-xiFAdxLt.js";import{b as ae,f as w}from"./dateUtils-DoPl8O0G.js";import{f as N}from"./numberUtils-CWVJ76A6.js";import{A as z,x as oe,E as ie,R as le,K as ne,s as B,a as K,r as de}from"./ui-vendor-B0ZOy8uN.js";import"./supabase-vendor-B-LuImWU.js";function ue(){var $,D,L,I,F,R,U,M;const[b,X]=p.useState([]),[H,T]=p.useState(!0),[g,J]=p.useState("all"),[f,Q]=p.useState(""),[a,S]=p.useState(null),[Y,h]=p.useState(!1),[y,E]=p.useState(null),[k,C]=p.useState(null);p.useEffect(()=>{_()},[g]);const _=async()=>{try{T(!0);const{data:{user:t}}=await m.auth.getUser();if(!t)return;const{data:s}=await m.from("company_users").select("company_id").eq("user_id",t.id).single();if(!s)return;let l=m.from("share_transfers").select(`
          *,
          grants (
            grant_number
          ),
          employees (
            first_name_en,
            last_name_en,
            email
          ),
          from_portfolio:from_portfolio_id (
            portfolio_number,
            portfolio_type
          ),
          to_portfolio:to_portfolio_id (
            portfolio_number,
            portfolio_type
          )
        `).eq("company_id",s.company_id).order("created_at",{ascending:!1});g!=="all"&&(l=l.eq("status",g));const{data:i,error:n}=await l;if(n)throw n;const o=i||[],x=await Promise.all(o.map(async r=>{var u;let d=null;if(r.notes){const c=r.notes.match(/vesting event ([a-f0-9-]+)/i);c&&c[1]&&(d=c[1])}if(!d&&r.grant_id&&r.employee_id){const{data:c}=await m.from("vesting_events").select("id").eq("grant_id",r.grant_id).eq("employee_id",r.employee_id).eq("shares_to_vest",r.shares_transferred).eq("status","transferred").order("updated_at",{ascending:!1}).limit(1).maybeSingle();c&&(d=c.id)}let j;if(d){const{data:c}=await m.from("vesting_events").select("id, sequence_number, vesting_date, grants(grant_number)").eq("id",d).maybeSingle();c&&(j=ae(c.id,c.sequence_number,c.vesting_date,((u=c.grants)==null?void 0:u.grant_number)||r.grant_id).displayId)}return{...r,vestingEventId:d,formattedEventId:j}}));X(x)}catch(t){console.error("Error loading transfers:",t),alert("Failed to load transfers")}finally{T(!1)}},q=async t=>{if(confirm("Are you sure you want to process this transfer? This will move the shares from the source portfolio to the destination portfolio.")){E(t);try{const{data:s,error:l}=await m.from("share_transfers").select("from_portfolio_id, to_portfolio_id, shares_transferred, status").eq("id",t).single();if(l)throw l;if(!s)throw new Error("Transfer not found");if(s.status==="transferred"){alert("This transfer has already been processed."),await _();return}if(!s.from_portfolio_id||!s.to_portfolio_id)throw new Error("Transfer is missing portfolio information");const i=Number(s.shares_transferred);if(i<=0)throw new Error("Invalid shares amount to transfer");const{data:n,error:o}=await m.from("portfolios").select("id, available_shares, locked_shares, total_shares, portfolio_type").in("id",[s.from_portfolio_id,s.to_portfolio_id]);if(o)throw o;if(!n||n.length!==2)throw new Error("Could not fetch portfolio information");const x=n.find(v=>v.id===s.from_portfolio_id),r=n.find(v=>v.id===s.to_portfolio_id);if(!x||!r)throw new Error("Portfolio information is incomplete");const d=Number(x.available_shares||0);if(d<i)throw new Error(`Insufficient shares in source portfolio. Available: ${d.toLocaleString()}, Required: ${i.toLocaleString()}`);const j=d-i,u=Number(x.locked_shares||0),c=Math.max(0,u-i),O=Number(r.total_shares||0),te=Number(r.available_shares||0),se=O+i,re=te+i,[G,V]=await Promise.all([m.from("portfolios").update({available_shares:j,locked_shares:c,updated_at:new Date().toISOString()}).eq("id",s.from_portfolio_id).select(),m.from("portfolios").update({total_shares:se,available_shares:re,updated_at:new Date().toISOString()}).eq("id",s.to_portfolio_id).select()]);if(G.error)throw new Error(`Failed to update source portfolio: ${G.error.message}`);if(V.error)throw await m.from("portfolios").update({available_shares:d,locked_shares:u,updated_at:new Date().toISOString()}).eq("id",s.from_portfolio_id),new Error(`Failed to update destination portfolio: ${V.error.message}`);const{error:W}=await m.from("share_transfers").update({status:"transferred",processed_at:new Date().toISOString()}).eq("id",t);W&&console.warn("Portfolios updated but transfer status update failed:",W),alert(`Transfer processed successfully! ${i.toLocaleString()} shares moved from company portfolio to employee portfolio.`),await _()}catch(s){console.error("Error processing transfer:",s);const l=(s==null?void 0:s.message)||"Unknown error occurred";alert(`Failed to process transfer: ${l}`)}finally{E(null)}}},Z=async(t,s)=>{var i,n;const l=`Are you sure you want to delete this transfer?

⚠️ WARNING: The related vesting event status will be changed back to "vested".

Transfer: ${s.transfer_number}
Employee: ${(i=s.employees)==null?void 0:i.first_name_en} ${(n=s.employees)==null?void 0:n.last_name_en}
Shares: ${N(s.shares_transferred)}`;if(confirm(l)){C(t);try{let o=null;if(s.notes){const r=s.notes.match(/vesting event ([a-f0-9-]+)/i);r&&r[1]&&(o=r[1])}if(!o&&s.grant_id&&s.employee_id){const{data:r,error:d}=await m.from("vesting_events").select("id, status").eq("grant_id",s.grant_id).eq("employee_id",s.employee_id).eq("shares_to_vest",s.shares_transferred).eq("status","transferred").order("updated_at",{ascending:!1}).limit(1);!d&&r&&r.length>0&&(o=r[0].id)}const{error:x}=await m.from("share_transfers").delete().eq("id",t);if(x)throw x;if(o){const{error:r}=await m.from("vesting_events").update({status:"vested",updated_at:new Date().toISOString()}).eq("id",o);r?(console.error("Error updating vesting event status:",r),console.warn("⚠️ Transfer deleted but vesting event status update failed. Event ID:",o),alert("Transfer deleted successfully, but failed to update vesting event status. Please update it manually.")):(console.log('✅ Updated vesting event status back to "vested" for event:',o),alert('Transfer deleted successfully. Vesting event status has been changed back to "vested".'))}else console.warn("⚠️ Could not find related vesting event for transfer:",t),alert("Transfer deleted successfully, but related vesting event could not be found. Please update the vesting event status manually.");await _()}catch(o){console.error("Error deleting transfer:",o);const x=(o==null?void 0:o.message)||"Unknown error occurred";alert(`Failed to delete transfer: ${x}`)}finally{C(null)}}},P=t=>{switch(t){case"transferred":return"bg-green-100 text-green-800";case"pending":return"bg-yellow-100 text-yellow-800";case"cancelled":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},ee=t=>{switch(t){case"transferred":return e.jsx(de,{className:"w-5 h-5 text-green-600"});case"pending":return e.jsx(K,{className:"w-5 h-5 text-yellow-600"});case"cancelled":return e.jsx(B,{className:"w-5 h-5 text-red-600"});default:return e.jsx(K,{className:"w-5 h-5 text-gray-600"})}},A=b.filter(t=>{var l,i,n,o;return t.transfer_number.toLowerCase().includes(f.toLowerCase())||((l=t.grants)==null?void 0:l.grant_number.toLowerCase().includes(f.toLowerCase()))||`${(i=t.employees)==null?void 0:i.first_name_en} ${(n=t.employees)==null?void 0:n.last_name_en}`.toLowerCase().includes(f.toLowerCase())||((o=t.employees)==null?void 0:o.email.toLowerCase().includes(f.toLowerCase()))});return H?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(z,{className:"w-8 h-8 text-blue-600"}),"Share Transfers",e.jsx("span",{className:"inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white text-lg font-semibold",children:b.length})]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage and process share transfer requests"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search by transfer number, grant, employee...",value:f,onChange:t=>Q(t.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsx("div",{className:"flex gap-2",children:["all","pending","transferred","cancelled"].map(t=>e.jsx("button",{onClick:()=>J(t),className:`px-4 py-2 rounded-lg font-medium transition ${g===t?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:t.charAt(0).toUpperCase()+t.slice(1)},t))})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Transfer Number"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Employee"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Grant"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Shares"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"From Portfolio"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"To Portfolio"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Transfer Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:A.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:9,className:"px-6 py-12 text-center text-gray-500",children:[e.jsx(z,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{children:"No transfers found"})]})}):A.map(t=>{var s,l,i,n,o,x,r,d;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("button",{onClick:()=>{S(t),h(!0)},className:"text-sm font-medium text-blue-600 hover:text-blue-900 hover:underline cursor-pointer",children:t.transfer_number})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-sm text-gray-900",children:[(s=t.employees)==null?void 0:s.first_name_en," ",(l=t.employees)==null?void 0:l.last_name_en]}),e.jsx("div",{className:"text-sm text-gray-500",children:(i=t.employees)==null?void 0:i.email})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:((n=t.grants)==null?void 0:n.grant_number)||"N/A"}),t.formattedEventId&&e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:t.formattedEventId})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:N(t.shares_transferred)})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:((o=t.from_portfolio)==null?void 0:o.portfolio_number)||"N/A"}),e.jsx("div",{className:"text-xs text-gray-500",children:((x=t.from_portfolio)==null?void 0:x.portfolio_type)||""})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:((r=t.to_portfolio)==null?void 0:r.portfolio_number)||"N/A"}),e.jsx("div",{className:"text-xs text-gray-500",children:((d=t.to_portfolio)==null?void 0:d.portfolio_type)||""})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-gray-900",children:w(t.transfer_date)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${P(t.status)}`,children:[ee(t.status),t.status.toUpperCase()]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{S(t),h(!0)},className:"text-blue-600 hover:text-blue-900",title:"View Details",children:e.jsx(ie,{className:"w-5 h-5"})}),t.status==="pending"&&e.jsx("button",{onClick:()=>q(t.id),disabled:y===t.id,className:"text-green-600 hover:text-green-900 disabled:opacity-50",title:"Process Transfer",children:e.jsx(le,{className:`w-5 h-5 ${y===t.id?"animate-spin":""}`})}),e.jsx("button",{onClick:()=>Z(t.id,t),disabled:k===t.id,className:"text-red-600 hover:text-red-900 disabled:opacity-50",title:"Delete Transfer",children:e.jsx(ne,{className:`w-5 h-5 ${k===t.id?"animate-spin":""}`})})]})})]},t.id)})})]})})}),Y&&a&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Transfer Details"}),e.jsx("p",{className:"text-gray-600 mt-1",children:a.transfer_number})]}),e.jsx("button",{onClick:()=>h(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(B,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"Transfer Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Transfer Number:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:a.transfer_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Status:"}),e.jsx("p",{className:"text-sm font-medium",children:e.jsx("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${P(a.status)}`,children:a.status.toUpperCase()})})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Transfer Date:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:w(a.transfer_date)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Transfer Type:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:a.transfer_type})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Shares Transferred:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:N(a.shares_transferred)})]}),a.market_price_at_transfer&&e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Market Price:"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["$",a.market_price_at_transfer.toFixed(2)]})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"Employee"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Name:"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[($=a.employees)==null?void 0:$.first_name_en," ",(D=a.employees)==null?void 0:D.last_name_en]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Email:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:(L=a.employees)==null?void 0:L.email})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Grant:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:((I=a.grants)==null?void 0:I.grant_number)||"N/A"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"Portfolio Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"From Portfolio:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:((F=a.from_portfolio)==null?void 0:F.portfolio_number)||"N/A"}),e.jsx("p",{className:"text-xs text-gray-500",children:((R=a.from_portfolio)==null?void 0:R.portfolio_type)||""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"To Portfolio:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:((U=a.to_portfolio)==null?void 0:U.portfolio_number)||"N/A"}),e.jsx("p",{className:"text-xs text-gray-500",children:((M=a.to_portfolio)==null?void 0:M.portfolio_type)||""})]})]})]}),a.notes&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"Notes"}),e.jsx("p",{className:"text-sm text-gray-600",children:a.notes})]}),a.processed_at&&e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Processed At:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:w(a.processed_at)})]})]}),e.jsxs("div",{className:"p-6 border-t border-gray-200 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>h(!1),className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Close"}),a.status==="pending"&&e.jsx("button",{onClick:()=>{h(!1),q(a.id)},disabled:y===a.id,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50",children:y===a.id?"Processing...":"Process Transfer"})]})]})})]})}export{ue as default};
