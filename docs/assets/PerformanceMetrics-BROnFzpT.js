import{s as d,j as e}from"./index-DDk1oefv.js";import{r as o,a as W}from"./react-vendor-xiFAdxLt.js";import{w as I,T as U,z as B,H as K,K as O,U as V,c as J,D as Q}from"./ui-vendor-B0ZOy8uN.js";import"./supabase-vendor-B-LuImWU.js";function te(){const[y,$]=o.useState([]),[A,q]=o.useState(!0),[F,g]=o.useState(!1),[v,b]=o.useState(null),[j,M]=o.useState("create"),[k,x]=o.useState(null),[f,p]=o.useState(null),[_,u]=o.useState(null),[s,m]=o.useState({name:"",description:"",metric_type:"operational",unit_of_measure:""});o.useEffect(()=>{w()},[]),o.useEffect(()=>{if(!f)return;const t=r=>{if(r instanceof KeyboardEvent){r.key==="Escape"&&(p(null),u(null));return}p(null),u(null)};return document.addEventListener("click",t),document.addEventListener("touchstart",t),document.addEventListener("keydown",t),window.addEventListener("resize",t),window.addEventListener("scroll",t,!0),()=>{document.removeEventListener("click",t),document.removeEventListener("touchstart",t),document.removeEventListener("keydown",t),window.removeEventListener("resize",t),window.removeEventListener("scroll",t,!0)}},[f]);const w=async()=>{try{const{data:{user:t}}=await d.auth.getUser();if(!t)return;const{data:r}=await d.from("company_users").select("company_id").eq("user_id",t.id).single();if(!r)return;const{data:l}=await d.from("performance_metrics").select(`
          *,
          grant_performance_metrics (
            grant_id,
            grants (
              id,
              grant_number,
              incentive_plans (plan_name_en, plan_code),
              employees (first_name_en, last_name_en)
            )
          )
        `).eq("company_id",r.company_id).order("created_at",{ascending:!1});if(l){const i=l.map(a=>({id:a.id,company_id:a.company_id,name:a.name,description:a.description,metric_type:a.metric_type,unit_of_measure:a.unit_of_measure,created_at:a.created_at,linkedGrants:(a.grant_performance_metrics||[]).map(n=>{var c,h,S,D,P,L,T;return{id:(c=n.grants)==null?void 0:c.id,grant_number:((h=n.grants)==null?void 0:h.grant_number)||"Grant",employee_name:(S=n.grants)!=null&&S.employees?`${n.grants.employees.first_name_en} ${n.grants.employees.last_name_en}`:"Employee",plan_name_en:((P=(D=n.grants)==null?void 0:D.incentive_plans)==null?void 0:P.plan_name_en)||null,plan_code:((T=(L=n.grants)==null?void 0:L.incentive_plans)==null?void 0:T.plan_code)||null}})}));$(i)}}catch(t){console.error("Error loading metrics:",t)}finally{q(!1)}},G=async()=>{try{const{data:{user:t}}=await d.auth.getUser();if(!t)return;const{data:r}=await d.from("company_users").select("company_id").eq("user_id",t.id).single();if(!r)return;let l=k;if(j==="create"){const{data:i,error:a}=await d.from("performance_metrics").insert({company_id:r.company_id,name:s.name,description:s.description,metric_type:s.metric_type,unit_of_measure:s.unit_of_measure}).select().single();if(a)throw a;l=(i==null?void 0:i.id)||null}else if(l){const{error:i}=await d.from("performance_metrics").update({name:s.name,description:s.description,metric_type:s.metric_type,unit_of_measure:s.unit_of_measure}).eq("id",l).eq("company_id",r.company_id);if(i)throw i}if(!l)throw new Error("Failed to determine performance metric ID");g(!1),N(),x(null),w()}catch(t){console.error("Error saving performance metric:",t),alert("Failed to save performance metric")}},z=async t=>{try{const{error:r}=await d.from("performance_metrics").delete().eq("id",t);if(r)throw r;b(null),k===t&&x(null),w()}catch(r){console.error("Error deleting metric:",r),alert("Failed to delete performance metric")}},N=()=>{m({name:"",description:"",metric_type:"operational",unit_of_measure:""})},R=t=>{switch(t){case"financial":return e.jsx(Q,{className:"w-5 h-5"});case"operational":return e.jsx(J,{className:"w-5 h-5"});case"personal":return e.jsx(V,{className:"w-5 h-5"});default:return e.jsx(U,{className:"w-5 h-5"})}},E=t=>{switch(t){case"financial":return"bg-green-100 text-green-800";case"operational":return"bg-blue-100 text-blue-800";case"personal":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}},C=()=>{M("create"),x(null),N(),g(!0)},H=t=>{M("edit"),x(t.id),m({name:t.name,description:t.description||"",metric_type:t.metric_type,unit_of_measure:t.unit_of_measure}),g(!0)};return A?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"text-gray-500",children:"Loading performance metrics..."})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-3",children:["Performance Metrics",e.jsx("span",{className:"inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white text-lg font-semibold",children:y.length})]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Define metrics for performance-based vesting"})]}),e.jsxs("button",{onClick:C,className:"flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsx("span",{children:"Add Metric"})]})]}),y.length===0?e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-12 text-center",children:[e.jsx(U,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No performance metrics yet"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Create metrics to enable performance-based vesting"}),e.jsxs("button",{onClick:C,className:"inline-flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsx("span",{children:"Add Metric"})]})]}):e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:"Metric"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:"Type"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:"Unit"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:"Description"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:"Linked Grants"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:y.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 transition",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${E(t.metric_type)}`,children:R(t.metric_type)}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:t.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:["ID: ",t.id.slice(0,8),"..."]})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${E(t.metric_type)}`,children:t.metric_type})}),e.jsx("td",{className:"px-6 py-4 text-sm font-medium text-gray-900",children:t.unit_of_measure}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:t.description?e.jsx("span",{className:"block max-w-md break-words",children:t.description}):e.jsx("span",{className:"text-xs text-gray-400",children:"No description"})}),e.jsx("td",{className:"px-6 py-4",children:t.linkedGrants.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:t.linkedGrants.map(r=>e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-medium",title:`${r.employee_name}${r.plan_name_en?` â€¢ ${r.plan_name_en}`:""}`,children:r.grant_number},`${t.id}-${r.id||r.grant_number}`))}):e.jsx("span",{className:"text-xs text-gray-400",children:"None"})}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:new Date(t.created_at).toLocaleDateString()}),e.jsxs("td",{className:"px-6 py-4 text-right",children:[e.jsx("button",{onClick:r=>{r.stopPropagation();const l=r.currentTarget.getBoundingClientRect(),i=176,a=112;let n=l.bottom+8,c=l.right-i;n+a>window.innerHeight&&(n=l.top-a-8),n<8&&(n=8),c+i>window.innerWidth&&(c=window.innerWidth-i-8),c<8&&(c=8),u({top:n,left:c}),p(h=>h===t.id?null:t.id)},onTouchStart:r=>r.stopPropagation(),className:"p-2 rounded-full hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition","aria-haspopup":"true","aria-expanded":f===t.id,"aria-label":"Metric actions",children:e.jsx(B,{className:"w-5 h-5"})}),f===t.id&&_&&W.createPortal(e.jsxs("div",{className:"fixed z-50 w-44 origin-top-right rounded-lg border border-gray-200 bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none",role:"menu","aria-orientation":"vertical",style:{top:_.top,left:_.left},onClick:r=>{r.stopPropagation()},onTouchStart:r=>r.stopPropagation(),children:[e.jsxs("button",{onClick:()=>{p(null),u(null),H(t)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2 transition",role:"menuitem",children:[e.jsx(K,{className:"w-4 h-4 text-blue-500"}),"Edit metric"]}),e.jsxs("button",{onClick:()=>{p(null),u(null),b(t.id)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition",role:"menuitem",children:[e.jsx(O,{className:"w-4 h-4"}),"Delete metric"]})]}),document.body)]})]},t.id))})]})})}),F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-2xl w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:j==="create"?"Add Performance Metric":"Edit Performance Metric"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Metric Name"}),e.jsx("input",{type:"text",value:s.name,onChange:t=>m({...s,name:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"e.g., Annual Revenue Target"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Description"}),e.jsx("textarea",{value:s.description,onChange:t=>m({...s,description:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,placeholder:"Brief description of this metric"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Metric Type"}),e.jsxs("select",{value:s.metric_type,onChange:t=>m({...s,metric_type:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"financial",children:"Financial"}),e.jsx("option",{value:"operational",children:"Operational"}),e.jsx("option",{value:"personal",children:"Personal"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit of Measure"}),e.jsx("input",{type:"text",value:s.unit_of_measure,onChange:t=>m({...s,unit_of_measure:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"e.g., SAR, users, %"})]})]}),e.jsx("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600",children:"Grant linkage for performance metrics is now managed from the Grants page when issuing or editing a grant."})]}),e.jsxs("div",{className:"p-6 border-t border-gray-200 flex items-center justify-end space-x-3",children:[e.jsx("button",{onClick:()=>{g(!1),N(),x(null)},className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{onClick:G,disabled:!s.name||!s.unit_of_measure,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed",children:j==="create"?"Add Metric":"Save Changes"})]})]})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Delete Performance Metric"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to delete this metric? This action cannot be undone."}),e.jsxs("div",{className:"flex items-center justify-end space-x-3",children:[e.jsx("button",{onClick:()=>b(null),className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{onClick:()=>z(v),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition",children:"Delete"})]})]})})]})}export{te as default};
