import{u as Se,s as x,j as e}from"./index-DDk1oefv.js";import{r}from"./react-vendor-xiFAdxLt.js";import{U as Ee,z as Ce,X as ue}from"./ui-vendor-B0ZOy8uN.js";import"./supabase-vendor-B-LuImWU.js";const pe=["company_admin","super_admin","finance_admin","legal_admin","hr_admin","viewer"],c=[{key:"dashboard",label:"Overview"},{key:"users",label:"Users"},{key:"employees",label:"Employees"},{key:"ltip_pools",label:"LTIP Pools"},{key:"plans",label:"Incentive Plans"},{key:"vesting_schedules",label:"Vesting Schedules"},{key:"vesting_events",label:"Vesting Events"},{key:"transfers",label:"Transfers"},{key:"performance_metrics",label:"Performance Metrics"},{key:"grants",label:"Grants"},{key:"documents",label:"Documents"},{key:"contract_approval",label:"Contract Approvals"},{key:"cap_table",label:"Cap Table"},{key:"portfolio",label:"Portfolio"},{key:"settings",label:"Settings"}],u=o=>c.reduce((p,k)=>(p[k.key]=!!(o!=null&&o[k.key]),p),{});function Re(){const[o,p]=r.useState([]),[k,he]=r.useState({}),[ge,y]=r.useState(!0),[L,h]=r.useState(null),[g,I]=r.useState(null),[R,D]=r.useState("finance_admin"),[_,q]=r.useState(!0),[F,T]=r.useState(!1),[z,m]=r.useState(null),[b,$]=r.useState(null),[B,V]=r.useState(""),[G,J]=r.useState(""),[O,j]=r.useState(()=>u()),[be,H]=r.useState(!1),[X,K]=r.useState(""),[Q,W]=r.useState("finance_admin"),[A,Y]=r.useState(!0),[Z,i]=r.useState(null),[ee,se]=r.useState(!1),[te,re]=r.useState(""),[ae,le]=r.useState(""),[ne,N]=r.useState(()=>u()),{user:Pe,getCurrentCompanyId:fe,userRole:v,loading:ie,onboardingLoaded:de}=Se(),S=fe(),ce=r.useMemo(()=>(v==null?void 0:v.user_type)==="super_admin",[v]);r.useEffect(()=>{if(!S){if(ie||!de){y(!0),h(null);return}$(null),p([]),h(ce?"Select a company to manage administrators.":"No company associated with the current user."),y(!1);return}E(S)},[S,ce,ie,de]);const E=async s=>{try{y(!0),h(null),$(s);const{data:t,error:a}=await x.from("company_users").select(`
          id,
          role,
          is_active,
          permissions,
          created_at,
          user_id,
          display_name_en,
          display_name_ar
        `).eq("company_id",s).neq("role","super_admin").order("created_at",{ascending:!0});if(a)throw a;const d=t||[],w=d.map(l=>l.user_id),f=Array.from(new Set(w)),U={};if(f.length>0){const{data:l,error:n}=await x.from("company_admin_users_view").select("id, email").in("id",f);if(n)throw n;(l||[]).forEach(xe=>{U[xe.id]=xe})}he(U);const Ae=d.map(l=>{const n=U[l.user_id];return{id:l.id,userId:l.user_id,email:(n==null?void 0:n.email)??null,name:l.display_name_en||l.display_name_ar||(n==null?void 0:n.email)||null,nameEn:l.display_name_en??null,nameAr:l.display_name_ar??null,rawRole:l.role,isActive:!!l.is_active,permissions:u(l.permissions??null),createdAt:l.created_at}});p(Ae)}catch(t){console.error("Error loading users:",t),h("Failed to load users.")}finally{y(!1)}},ye=s=>{const t=c.filter(a=>s[a.key]);return t.length===c.length?e.jsx("span",{className:"text-sm text-green-700",children:"Full access to all modules"}):t.length===0?e.jsx("span",{className:"text-sm text-gray-500",children:"No modules enabled"}):e.jsx("div",{className:"flex flex-wrap gap-2",children:t.map(a=>e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200",children:a.label},a.key))})},je=s=>{I(s),D(s.rawRole??"finance_admin"),q(s.isActive),V(s.nameEn||""),J(s.nameAr||""),j({...s.permissions}),m(null)},C=()=>{I(null),m(null),j(u())},Ne=async()=>{if(g)try{T(!0),m(null);const{error:s,data:t}=await x.from("company_users").update({role:R,is_active:_,display_name_en:B.trim()||null,display_name_ar:G.trim()||null,permissions:O}).eq("id",g.id).select();if(s){console.error("Error updating user:",s),m(`Failed to save changes: ${s.message||"Permission denied. Please ensure you have admin privileges."}`);return}if(!t||t.length===0){m("Update completed but no data returned. This may indicate a permissions issue.");return}C(),await E(b)}catch(s){console.error("Error updating user:",s),m(`Failed to save changes: ${(s==null?void 0:s.message)||"Unknown error occurred"}`)}finally{T(!1)}},P=s=>s?s.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase()):"Unknown",ve=s=>{j(t=>({...t,[s]:!t[s]}))},we=s=>{N(t=>({...t,[s]:!t[s]}))},oe=s=>{j(t=>{const a={...t};return c.forEach(d=>{a[d.key]=s}),a})},me=s=>{N(t=>{const a={...t};return c.forEach(d=>{a[d.key]=s}),a})},ke=()=>{K(""),W("finance_admin"),Y(!0),re(""),le(""),N(u()),i(null),H(!0)},M=()=>{H(!1),i(null),N(u())},_e=async()=>{if(!b){i("Missing company reference. Please refresh and try again.");return}const s=X.trim().toLowerCase();if(!s){i("Please enter an email address.");return}try{se(!0),i(null);const{data:t,error:a}=await x.from("company_admin_users_view").select("id, email").eq("email",s).maybeSingle();if(a)throw a;if(!t){i("No Supabase user found with that email. Create the account first.");return}const{data:d,error:w}=await x.from("company_users").select("id").eq("company_id",b).eq("user_id",t.id).maybeSingle();if(w)throw w;if(d){i("This user is already linked to the company.");return}const{error:f}=await x.from("company_users").insert({company_id:b,user_id:t.id,role:Q,is_active:A,display_name_en:te.trim()||null,display_name_ar:ae.trim()||null,permissions:ne});if(f)throw f;M(),await E(b)}catch(t){console.error("Error adding company user:",t),i("Failed to add user.")}finally{se(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Company Users"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage administrative users and review their permissions."})]}),e.jsx("button",{onClick:ke,className:"inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500",children:"Add User"})]}),L&&e.jsx("div",{className:"p-4 rounded-lg border border-red-200 bg-red-50 text-red-700",children:L}),ge?e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-12 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading users..."})]}):e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(Ee,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Administrative Users"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Super Admins, Finance Admins, Legal Admins, and HR Admins"})]})]})}),o.length===0?e.jsx("div",{className:"p-10 text-center text-gray-500",children:"No administrative users found for this company."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"User"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Role"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Permissions"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Added On"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:o.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.name||s.email||s.userId}),e.jsx("div",{className:"text-sm text-gray-500",children:s.email||s.userId})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 capitalize",children:P(s.rawRole)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${s.isActive?"bg-green-50 text-green-700":"bg-gray-100 text-gray-500"}`,children:s.isActive?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-4",children:ye(s.permissions)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.createdAt?new Date(s.createdAt).toLocaleDateString("en-GB"):"N/A"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm",children:e.jsx("button",{onClick:()=>je(s),className:"p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":`Actions for ${s.email||s.userId}`,children:e.jsx(Ce,{className:"w-5 h-5 text-gray-500"})})})]},s.id))})]})})]}),g&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit User"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Update role and status for ",g.email||g.userId]})]}),e.jsx("button",{onClick:C,className:"text-gray-400 hover:text-gray-600","aria-label":"Close edit modal",children:e.jsx(ue,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-5 space-y-5",children:[z&&e.jsx("div",{className:"p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 text-sm",children:z}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),e.jsx("select",{value:R,onChange:s=>D(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:pe.map(s=>e.jsx("option",{value:s,children:P(s)},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"text-sm text-gray-500",children:_?"Active":"Inactive"}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:_,onChange:s=>q(s.target.checked)}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Display Name (English)"}),e.jsx("input",{type:"text",value:B,onChange:s=>V(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"John Doe"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Display Name (Arabic)"}),e.jsx("input",{type:"text",value:G,onChange:s=>J(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right",placeholder:"جون دو",dir:"rtl"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Module Permissions"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("button",{type:"button",onClick:()=>oe(!0),className:"text-blue-600 hover:text-blue-800",children:"Select all"}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsx("button",{type:"button",onClick:()=>oe(!1),className:"text-blue-600 hover:text-blue-800",children:"Clear all"})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:c.map(s=>e.jsxs("label",{className:"flex items-center space-x-2 rounded-lg border border-gray-200 px-3 py-2 hover:border-blue-300",children:[e.jsx("input",{type:"checkbox",checked:O[s.key],onChange:()=>ve(s.key),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:s.label})]},s.key))})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsx("button",{onClick:C,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800",type:"button",children:"Cancel"}),e.jsx("button",{onClick:Ne,disabled:F,className:"px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",type:"button",children:F?"Saving...":"Save Changes"})]})]})}),be&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Add Company User"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Link an existing Supabase user to this company with an admin role."})]}),e.jsx("button",{onClick:M,className:"text-gray-400 hover:text-gray-600","aria-label":"Close add modal",children:e.jsx(ue,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-5 space-y-5",children:[Z&&e.jsx("div",{className:"p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 text-sm",children:Z}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"User Email"}),e.jsx("input",{type:"email",value:X,onChange:s=>K(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"name@example.com"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"The user must already exist in Supabase authentication."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),e.jsx("select",{value:Q,onChange:s=>W(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:pe.map(s=>e.jsx("option",{value:s,children:P(s)},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"text-sm text-gray-500",children:A?"Active":"Inactive"}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:A,onChange:s=>Y(s.target.checked)}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Display Name (English)"}),e.jsx("input",{type:"text",value:te,onChange:s=>re(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"John Doe"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Display Name (Arabic)"}),e.jsx("input",{type:"text",value:ae,onChange:s=>le(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right",placeholder:"جون دو",dir:"rtl"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Module Permissions"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("button",{type:"button",onClick:()=>me(!0),className:"text-blue-600 hover:text-blue-800",children:"Select all"}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsx("button",{type:"button",onClick:()=>me(!1),className:"text-blue-600 hover:text-blue-800",children:"Clear all"})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:c.map(s=>e.jsxs("label",{className:"flex items-center space-x-2 rounded-lg border border-gray-200 px-3 py-2 hover:border-blue-300",children:[e.jsx("input",{type:"checkbox",checked:ne[s.key],onChange:()=>we(s.key),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:s.label})]},s.key))})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsx("button",{onClick:M,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800",type:"button",children:"Cancel"}),e.jsx("button",{onClick:_e,disabled:ee,className:"px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",type:"button",children:ee?"Saving...":"Add User"})]})]})})]})}export{Re as default};
