import{a as H,s as m,j as e}from"./index-CHcuUdej.js";import{r as h}from"./react-vendor-xiFAdxLt.js";import{f as J}from"./dateUtils-DoPl8O0G.js";import{B as E,c as R,D as K,C as W,r as X,m as Y,Q as Z,A as _,q as ee}from"./ui-vendor-a8g5-7pO.js";import"./supabase-vendor-B-LuImWU.js";function de(){const{t:s,i18n:I}=H(),v=I.language==="ar",[w,$]=h.useState([]),[o,C]=h.useState({total_grants:0,total_shares:0,vested_shares:0,unvested_shares:0}),[y,S]=h.useState({total_allocated:0,total_granted:0,total_available:0}),[F,M]=h.useState(!0),[se,V]=h.useState(null),[L,D]=h.useState([]),[P,U]=h.useState(0);h.useEffect(()=>{B()},[]);const B=async()=>{try{const{data:{user:r}}=await m.auth.getUser();if(!r)return;const{data:n}=await m.from("company_users").select("company_id, companies(*)").eq("user_id",r.id).maybeSingle();if(n){V(n);const[O,p,j,te]=await Promise.all([m.from("portfolios").select("*").eq("company_id",n.company_id),m.from("grants").select("id, total_shares, vested_shares, remaining_unvested_shares, status").eq("company_id",n.company_id),m.from("incentive_plans").select("total_shares_allocated, shares_granted").eq("company_id",n.company_id),m.from("shareholders").select("shares_owned").eq("company_id",n.company_id).eq("shareholder_type","employee").eq("is_active",!0)]);$(O.data||[]);const N=(p.data||[]).filter(a=>a.status==="active").map(a=>a.id);let b=[];if(N.length>0){const{data:a,error:l}=await m.from("vesting_events").select("grant_id, shares_to_vest, status").in("grant_id",N);l?console.warn("Error loading vesting events:",l):b=a||[]}const f={},k=["vested","transferred","exercised","due"];if(b.forEach(a=>{f[a.grant_id]||(f[a.grant_id]=0),k.includes(a.status)&&(f[a.grant_id]+=Math.floor(Number(a.shares_to_vest||0)))}),p.data){const a=p.data,l=a.filter(c=>c.status==="active"),d=a.reduce((c,g)=>c+Math.floor(Number(g.total_shares||0)),0),i=l.reduce((c,g)=>{const G=Number(g.total_shares||0),Q=f[g.id]||0,q=Math.min(Q,G),z=Math.max(0,G-q);return{total_grants:c.total_grants+1,vested_shares:c.vested_shares+q,unvested_shares:c.unvested_shares+z}},{total_grants:0,vested_shares:0,unvested_shares:0});console.log("ðŸ“Š Portfolio Calculation Debug:"),console.log("All grants (total):",a.length),console.log("Active grants:",l.length),console.log("Active grant IDs:",N),console.log("Vesting events found:",(b==null?void 0:b.length)||0),console.log("Vested shares by grant:",f),console.log("Vested statuses used:",k);const x={};b.forEach(c=>{const g=c.status||"unknown";x[g]=(x[g]||0)+Math.floor(Number(c.shares_to_vest||0))}),console.log("Status breakdown (shares per status):",x);const A={total_grants:i.total_grants,total_shares:d,vested_shares:i.vested_shares,unvested_shares:i.unvested_shares};console.log("Final summary:",A),console.log("Total granted (all grants):",d),console.log("Vested (active grants only):",i.vested_shares),console.log("Unvested (active grants only):",i.unvested_shares),C(A)}const{data:u}=await m.from("ltip_pools").select("total_shares_allocated").eq("company_id",n.company_id).eq("status","active");if(u){const a=u.reduce((l,d)=>l+Number(d.total_shares_allocated||0),0);U(a)}if(p.data&&p.data.length>0){const a=p.data.reduce((i,x)=>i+Number(x.total_shares||0),0);let l=(u==null?void 0:u.reduce((i,x)=>i+Number(x.total_shares_allocated||0),0))||0;l===0&&j.data&&(l=j.data.reduce((i,x)=>i+Number(x.total_shares_allocated||0),0));const d={total_allocated:l,total_granted:a,total_available:l-a};S(d)}else if(j.data){const a=j.data.reduce((l,d)=>({total_allocated:l.total_allocated+Number(d.total_shares_allocated||0),total_granted:l.total_granted+Number(d.shares_granted||0),total_available:l.total_available+(Number(d.total_shares_allocated||0)-Number(d.shares_granted||0))}),{total_allocated:0,total_granted:0,total_available:0});S(a)}const{data:T}=await m.from("share_transfers").select(`
            id,
            transfer_number,
            shares_transferred,
            transfer_date,
            status,
            transfer_type,
            employees (
              first_name_en,
              last_name_en
            ),
            grants (
              grant_number
            )
          `).eq("company_id",n.company_id).order("created_at",{ascending:!1}).limit(10);T&&D(T)}}catch(r){console.error("Error loading portfolio data:",r)}finally{M(!1)}};if(F)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});const t=w.find(r=>r.portfolio_type==="company_reserved");return w.find(r=>r.portfolio_type==="employee_vested"),e.jsxs("div",{className:`space-y-6 ${v?"text-right":"text-left"}`,dir:v?"rtl":"ltr",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:s("portfolio.title")}),e.jsx("p",{className:"text-gray-600 mt-1",children:s("portfolio.description")})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg",children:e.jsx(E,{className:"w-6 h-6 text-blue-600"})})}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:s("portfolio.ltipPoolAllocated")}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:y.total_allocated.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Available: ",y.total_available.toLocaleString()]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"bg-green-100 p-3 rounded-lg",children:e.jsx(R,{className:"w-6 h-6 text-green-600"})})}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:s("portfolio.grantedShares")}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:o.total_shares.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Active Grants: ",o.total_grants]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"bg-emerald-100 p-3 rounded-lg",children:e.jsx(K,{className:"w-6 h-6 text-emerald-600"})})}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:s("portfolio.vestedShares")}),e.jsx("p",{className:"text-2xl font-bold text-emerald-600",children:o.vested_shares.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[o.total_shares>0?(o.vested_shares/o.total_shares*100).toFixed(1):0,"% of Granted"]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"bg-amber-100 p-3 rounded-lg",children:e.jsx(W,{className:"w-6 h-6 text-amber-600"})})}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:s("portfolio.unvestedShares")}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:o.unvested_shares.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[o.total_shares>0?(o.unvested_shares/o.total_shares*100).toFixed(1):0,"% of Granted"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:s("portfolio.grantSummary")})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("portfolio.totalGrantsIssued")}),e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:o.total_grants})]}),e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("portfolio.totalSharesGranted")}),e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:o.total_shares.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("portfolio.vestedSharesLabel")}),e.jsx("span",{className:"text-lg font-semibold text-green-600",children:o.vested_shares.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("portfolio.unvestedSharesLabel")}),e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:o.unvested_shares.toLocaleString()})]})]})})]}),t&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(X,{className:"w-5 h-5 text-blue-600"}),"Company Reserved Portfolio"]}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Portfolio Number: ",t.portfolio_number]}),P>0&&e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["Synced with LTIP Pools: ",P.toLocaleString()," shares"]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${Number(t.available_shares)>0?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:Number(t.available_shares)>0?s("portfolio.active"):s("portfolio.fullyAllocated")})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:s("portfolio.totalShares")}),e.jsx(E,{className:"w-4 h-4 text-gray-400"})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:Number(t.total_shares).toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.total_shares>0?`${(t.total_shares/(y.total_allocated||t.total_shares)*100).toFixed(1)}% of LTIP Pool`:s("portfolio.noSharesAllocated")})]}),e.jsxs("div",{className:"bg-green-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:s("portfolio.available")}),e.jsx(R,{className:"w-4 h-4 text-green-400"})]}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:Number(t.available_shares).toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.total_shares>0?`${(t.available_shares/t.total_shares*100).toFixed(1)}% of total`:s("portfolio.noSharesAvailable")})]}),e.jsxs("div",{className:"bg-amber-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Locked (Granted)"}),e.jsx(Y,{className:"w-4 h-4 text-amber-400"})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:Number(t.locked_shares).toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.total_shares>0?`${(t.locked_shares/t.total_shares*100).toFixed(1)}% of total`:s("portfolio.noSharesLocked")})]})]}),t.total_shares>0&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Portfolio Allocation"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[(t.available_shares/t.total_shares*100).toFixed(1),"% Available"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 overflow-hidden",children:e.jsxs("div",{className:"flex h-full",children:[e.jsx("div",{className:"bg-green-500 transition-all duration-300",style:{width:`${t.available_shares/t.total_shares*100}%`}}),e.jsx("div",{className:"bg-amber-500 transition-all duration-300",style:{width:`${t.locked_shares/t.total_shares*100}%`}})]})}),e.jsxs("div",{className:"flex items-center justify-between mt-2 text-xs text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded"}),e.jsx("span",{children:s("portfolio.available")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-amber-500 rounded"}),e.jsx("span",{children:"Locked (Granted)"})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4"}),"Share Movement Flow"]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-600",children:[e.jsx("div",{className:"flex-1 text-center",children:e.jsxs("div",{className:"bg-blue-50 rounded-lg p-3 mb-2",children:[e.jsx("p",{className:"font-semibold text-blue-900",children:s("portfolio.ltipPools")}),e.jsxs("p",{className:"text-blue-700",children:[y.total_allocated.toLocaleString()," shares"]})]})}),e.jsx(_,{className:"w-5 h-5 text-gray-400 mx-2"}),e.jsx("div",{className:"flex-1 text-center",children:e.jsxs("div",{className:"bg-purple-50 rounded-lg p-3 mb-2",children:[e.jsx("p",{className:"font-semibold text-purple-900",children:s("portfolio.companyPortfolio")}),e.jsxs("p",{className:"text-purple-700",children:[t.total_shares.toLocaleString()," shares"]})]})}),e.jsx(_,{className:"w-5 h-5 text-gray-400 mx-2"}),e.jsx("div",{className:"flex-1 text-center",children:e.jsxs("div",{className:"bg-green-50 rounded-lg p-3 mb-2",children:[e.jsx("p",{className:"font-semibold text-green-900",children:s("portfolio.employeeGrants")}),e.jsxs("p",{className:"text-green-700",children:[o.total_shares.toLocaleString()," shares"]})]})})]})]})]})]}),L.length>0&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5 text-blue-600"}),s("portfolio.recentTransfers")]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s("portfolio.latestShareMovements")})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Transfer #"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Employee"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Grant"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Shares"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:L.map(r=>{var n;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:r.transfer_number}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:r.employees?`${r.employees.first_name_en} ${r.employees.last_name_en}`:"N/A"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:((n=r.grants)==null?void 0:n.grant_number)||"N/A"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:Number(r.shares_transferred).toLocaleString()}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:J(r.transfer_date)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${r.status==="transferred"?"bg-green-100 text-green-800":r.status==="pending"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:r.status})})]},r.id)})})]})})]}),e.jsx("div",{className:"bg-blue-50 rounded-lg border border-blue-200 p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(ee,{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-semibold text-blue-900 mb-1",children:s("portfolio.portfolioOverview")}),e.jsxs("p",{className:"text-sm text-blue-800 mb-2",children:[e.jsx("strong",{children:"LTIP Pool:"})," Total shares allocated across all LTIP pools or incentive plans for employee equity grants.",e.jsx("br",{}),e.jsx("strong",{children:"Company Reserved Portfolio:"})," Automatically synced with LTIP pools, tracks total shares, available shares, and locked (granted) shares.",e.jsx("br",{}),e.jsx("strong",{children:"Granted Shares:"})," Total shares granted to employees through active equity grants (these shares are locked in the company portfolio until transferred).",e.jsx("br",{}),e.jsx("strong",{children:"Vested/Unvested:"})," Breakdown of granted shares based on vesting status."]}),e.jsxs("p",{className:"text-xs text-blue-700 mt-2",children:[e.jsx("strong",{children:"Note:"})," The Company Reserved Portfolio automatically updates when LTIP pools, incentive plans, or grants are created or modified."]})]})]})})]})}export{de as default};
