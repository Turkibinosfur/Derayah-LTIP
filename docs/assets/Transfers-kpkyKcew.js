import{a as le,s as x,j as e}from"./index-CHcuUdej.js";import{r as p}from"./react-vendor-xiFAdxLt.js";import{b as ie,f as b}from"./dateUtils-DoPl8O0G.js";import{f as T}from"./numberUtils-CWVJ76A6.js";import{A as H,y as de,H as ce,R as me,N as xe,t as X,a as J,s as fe}from"./ui-vendor-a8g5-7pO.js";import"./supabase-vendor-B-LuImWU.js";function je(){var L,I,F,R,U,M,O,G;const{t:c,i18n:K}=le(),y=K.language==="ar",[S,Q]=p.useState([]),[Y,E]=p.useState(!0),[_,Z]=p.useState("all"),[h,ee]=p.useState(""),[a,k]=p.useState(null),[te,u]=p.useState(!1),[j,C]=p.useState(null),[q,$]=p.useState(null);p.useEffect(()=>{v()},[_]);const v=async()=>{try{E(!0);const{data:{user:t}}=await x.auth.getUser();if(!t)return;const{data:s}=await x.from("company_users").select("company_id").eq("user_id",t.id).single();if(!s)return;let l=x.from("share_transfers").select(`
          *,
          grants (
            grant_number
          ),
          employees (
            first_name_en,
            last_name_en,
            email
          ),
          from_portfolio:from_portfolio_id (
            portfolio_number,
            portfolio_type
          ),
          to_portfolio:to_portfolio_id (
            portfolio_number,
            portfolio_type
          )
        `).eq("company_id",s.company_id).order("created_at",{ascending:!1});_!=="all"&&(l=l.eq("status",_));const{data:n,error:i}=await l;if(i)throw i;const o=n||[],f=await Promise.all(o.map(async r=>{var g;let d=null;if(r.notes){const m=r.notes.match(/vesting event ([a-f0-9-]+)/i);m&&m[1]&&(d=m[1])}if(!d&&r.grant_id&&r.employee_id){const{data:m}=await x.from("vesting_events").select("id").eq("grant_id",r.grant_id).eq("employee_id",r.employee_id).eq("shares_to_vest",r.shares_transferred).eq("status","transferred").order("updated_at",{ascending:!1}).limit(1).maybeSingle();m&&(d=m.id)}let w;if(d){const{data:m}=await x.from("vesting_events").select("id, sequence_number, vesting_date, grants(grant_number)").eq("id",d).maybeSingle();m&&(w=ie(m.id,m.sequence_number,m.vesting_date,((g=m.grants)==null?void 0:g.grant_number)||r.grant_id).displayId)}return{...r,vestingEventId:d,formattedEventId:w}}));Q(f)}catch(t){console.error("Error loading transfers:",t),alert("Failed to load transfers")}finally{E(!1)}},A=async t=>{if(confirm("Are you sure you want to process this transfer? This will move the shares from the source portfolio to the destination portfolio.")){C(t);try{const{data:s,error:l}=await x.from("share_transfers").select("from_portfolio_id, to_portfolio_id, shares_transferred, status").eq("id",t).single();if(l)throw l;if(!s)throw new Error("Transfer not found");if(s.status==="transferred"){alert("This transfer has already been processed."),await v();return}if(!s.from_portfolio_id||!s.to_portfolio_id)throw new Error("Transfer is missing portfolio information");const n=Number(s.shares_transferred);if(n<=0)throw new Error("Invalid shares amount to transfer");const{data:i,error:o}=await x.from("portfolios").select("id, available_shares, locked_shares, total_shares, portfolio_type").in("id",[s.from_portfolio_id,s.to_portfolio_id]);if(o)throw o;if(!i||i.length!==2)throw new Error("Could not fetch portfolio information");const f=i.find(N=>N.id===s.from_portfolio_id),r=i.find(N=>N.id===s.to_portfolio_id);if(!f||!r)throw new Error("Portfolio information is incomplete");const d=Number(f.available_shares||0);if(d<n)throw new Error(`Insufficient shares in source portfolio. Available: ${d.toLocaleString()}, Required: ${n.toLocaleString()}`);const w=d-n,g=Number(f.locked_shares||0),m=Math.max(0,g-n),V=Number(r.total_shares||0),ae=Number(r.available_shares||0),oe=V+n,ne=ae+n,[W,z]=await Promise.all([x.from("portfolios").update({available_shares:w,locked_shares:m,updated_at:new Date().toISOString()}).eq("id",s.from_portfolio_id).select(),x.from("portfolios").update({total_shares:oe,available_shares:ne,updated_at:new Date().toISOString()}).eq("id",s.to_portfolio_id).select()]);if(W.error)throw new Error(`Failed to update source portfolio: ${W.error.message}`);if(z.error)throw await x.from("portfolios").update({available_shares:d,locked_shares:g,updated_at:new Date().toISOString()}).eq("id",s.from_portfolio_id),new Error(`Failed to update destination portfolio: ${z.error.message}`);const{error:B}=await x.from("share_transfers").update({status:"transferred",processed_at:new Date().toISOString()}).eq("id",t);B&&console.warn("Portfolios updated but transfer status update failed:",B),alert(`Transfer processed successfully! ${n.toLocaleString()} shares moved from company portfolio to employee portfolio.`),await v()}catch(s){console.error("Error processing transfer:",s);const l=(s==null?void 0:s.message)||"Unknown error occurred";alert(`Failed to process transfer: ${l}`)}finally{C(null)}}},se=async(t,s)=>{var n,i;const l=`Are you sure you want to delete this transfer?

⚠️ WARNING: The related vesting event status will be changed back to "vested".

Transfer: ${s.transfer_number}
Employee: ${(n=s.employees)==null?void 0:n.first_name_en} ${(i=s.employees)==null?void 0:i.last_name_en}
Shares: ${T(s.shares_transferred)}`;if(confirm(l)){$(t);try{let o=null;if(s.notes){const r=s.notes.match(/vesting event ([a-f0-9-]+)/i);r&&r[1]&&(o=r[1])}if(!o&&s.grant_id&&s.employee_id){const{data:r,error:d}=await x.from("vesting_events").select("id, status").eq("grant_id",s.grant_id).eq("employee_id",s.employee_id).eq("shares_to_vest",s.shares_transferred).eq("status","transferred").order("updated_at",{ascending:!1}).limit(1);!d&&r&&r.length>0&&(o=r[0].id)}const{error:f}=await x.from("share_transfers").delete().eq("id",t);if(f)throw f;if(o){const{error:r}=await x.from("vesting_events").update({status:"vested",updated_at:new Date().toISOString()}).eq("id",o);r?(console.error("Error updating vesting event status:",r),console.warn("⚠️ Transfer deleted but vesting event status update failed. Event ID:",o),alert("Transfer deleted successfully, but failed to update vesting event status. Please update it manually.")):(console.log('✅ Updated vesting event status back to "vested" for event:',o),alert('Transfer deleted successfully. Vesting event status has been changed back to "vested".'))}else console.warn("⚠️ Could not find related vesting event for transfer:",t),alert("Transfer deleted successfully, but related vesting event could not be found. Please update the vesting event status manually.");await v()}catch(o){console.error("Error deleting transfer:",o);const f=(o==null?void 0:o.message)||"Unknown error occurred";alert(`Failed to delete transfer: ${f}`)}finally{$(null)}}},D=t=>{switch(t){case"transferred":return"bg-green-100 text-green-800";case"pending":return"bg-yellow-100 text-yellow-800";case"cancelled":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},re=t=>{switch(t){case"transferred":return e.jsx(fe,{className:"w-5 h-5 text-green-600"});case"pending":return e.jsx(J,{className:"w-5 h-5 text-yellow-600"});case"cancelled":return e.jsx(X,{className:"w-5 h-5 text-red-600"});default:return e.jsx(J,{className:"w-5 h-5 text-gray-600"})}},P=S.filter(t=>{var l,n,i,o;return t.transfer_number.toLowerCase().includes(h.toLowerCase())||((l=t.grants)==null?void 0:l.grant_number.toLowerCase().includes(h.toLowerCase()))||`${(n=t.employees)==null?void 0:n.first_name_en} ${(i=t.employees)==null?void 0:i.last_name_en}`.toLowerCase().includes(h.toLowerCase())||((o=t.employees)==null?void 0:o.email.toLowerCase().includes(h.toLowerCase()))});return Y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:`space-y-6 ${y?"text-right":"text-left"}`,dir:y?"rtl":"ltr",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:y?"text-right":"",children:[e.jsxs("h1",{className:`text-3xl font-bold text-gray-900 flex items-center gap-3 ${y?"flex-row-reverse justify-end":""}`,children:[e.jsx(H,{className:"w-8 h-8 text-blue-600"}),c("transfers.title"),e.jsx("span",{className:"inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white text-lg font-semibold",children:S.length})]}),e.jsx("p",{className:"text-gray-600 mt-1",children:c("transfers.description")})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(de,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:c("transfers.searchPlaceholder"),value:h,onChange:t=>ee(t.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsx("div",{className:"flex gap-2",children:["all","pending","transferred","cancelled"].map(t=>{const s={all:c("transfers.all"),pending:c("transfers.pending"),transferred:c("transfers.transferred"),cancelled:c("transfers.cancelled")};return e.jsx("button",{onClick:()=>Z(t),className:`px-4 py-2 rounded-lg font-medium transition ${_===t?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:s[t]},t)})})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Transfer Number"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Employee"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Grant"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Shares"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"From Portfolio"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"To Portfolio"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Transfer Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:P.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:9,className:"px-6 py-12 text-center text-gray-500",children:[e.jsx(H,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{children:c("transfers.noTransfersFound")})]})}):P.map(t=>{var s,l,n,i,o,f,r,d;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("button",{onClick:()=>{k(t),u(!0)},className:"text-sm font-medium text-blue-600 hover:text-blue-900 hover:underline cursor-pointer",children:t.transfer_number})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-sm text-gray-900",children:[(s=t.employees)==null?void 0:s.first_name_en," ",(l=t.employees)==null?void 0:l.last_name_en]}),e.jsx("div",{className:"text-sm text-gray-500",children:(n=t.employees)==null?void 0:n.email})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:((i=t.grants)==null?void 0:i.grant_number)||"N/A"}),t.formattedEventId&&e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:t.formattedEventId})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:T(t.shares_transferred)})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:((o=t.from_portfolio)==null?void 0:o.portfolio_number)||"N/A"}),e.jsx("div",{className:"text-xs text-gray-500",children:((f=t.from_portfolio)==null?void 0:f.portfolio_type)||""})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:((r=t.to_portfolio)==null?void 0:r.portfolio_number)||"N/A"}),e.jsx("div",{className:"text-xs text-gray-500",children:((d=t.to_portfolio)==null?void 0:d.portfolio_type)||""})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-gray-900",children:b(t.transfer_date)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${D(t.status)}`,children:[re(t.status),t.status.toUpperCase()]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{k(t),u(!0)},className:"text-blue-600 hover:text-blue-900",title:"View Details",children:e.jsx(ce,{className:"w-5 h-5"})}),t.status==="pending"&&e.jsx("button",{onClick:()=>A(t.id),disabled:j===t.id,className:"text-green-600 hover:text-green-900 disabled:opacity-50",title:"Process Transfer",children:e.jsx(me,{className:`w-5 h-5 ${j===t.id?"animate-spin":""}`})}),e.jsx("button",{onClick:()=>se(t.id,t),disabled:q===t.id,className:"text-red-600 hover:text-red-900 disabled:opacity-50",title:"Delete Transfer",children:e.jsx(xe,{className:`w-5 h-5 ${q===t.id?"animate-spin":""}`})})]})})]},t.id)})})]})})}),te&&a&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:c("transfers.transferDetails")}),e.jsx("p",{className:"text-gray-600 mt-1",children:a.transfer_number})]}),e.jsx("button",{onClick:()=>u(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(X,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:c("transfers.transferInformation")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Transfer Number:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:a.transfer_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Status:"}),e.jsx("p",{className:"text-sm font-medium",children:e.jsx("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${D(a.status)}`,children:a.status.toUpperCase()})})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Transfer Date:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:b(a.transfer_date)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Transfer Type:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:a.transfer_type})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Shares Transferred:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:T(a.shares_transferred)})]}),a.market_price_at_transfer&&e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Market Price:"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["$",a.market_price_at_transfer.toFixed(2)]})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:c("transfers.employee")}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Name:"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[(L=a.employees)==null?void 0:L.first_name_en," ",(I=a.employees)==null?void 0:I.last_name_en]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Email:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:(F=a.employees)==null?void 0:F.email})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Grant:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:((R=a.grants)==null?void 0:R.grant_number)||"N/A"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:c("transfers.portfolioDetails")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"From Portfolio:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:((U=a.from_portfolio)==null?void 0:U.portfolio_number)||"N/A"}),e.jsx("p",{className:"text-xs text-gray-500",children:((M=a.from_portfolio)==null?void 0:M.portfolio_type)||""})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"To Portfolio:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:((O=a.to_portfolio)==null?void 0:O.portfolio_number)||"N/A"}),e.jsx("p",{className:"text-xs text-gray-500",children:((G=a.to_portfolio)==null?void 0:G.portfolio_type)||""})]})]})]}),a.notes&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:c("transfers.notes")}),e.jsx("p",{className:"text-sm text-gray-600",children:a.notes})]}),a.processed_at&&e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Processed At:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:b(a.processed_at)})]})]}),e.jsxs("div",{className:"p-6 border-t border-gray-200 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>u(!1),className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Close"}),a.status==="pending"&&e.jsx("button",{onClick:()=>{u(!1),A(a.id)},disabled:j===a.id,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50",children:j===a.id?c("transfers.processing"):c("transfers.processTransfer")})]})]})})]})}export{je as default};
