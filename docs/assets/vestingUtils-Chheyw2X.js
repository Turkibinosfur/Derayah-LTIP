import{s as q}from"./index-DDk1oefv.js";const N=async(_,d,m=!1)=>{var v;try{const{data:u,error:c}=await q.from("vesting_schedules").select(`
        *,
        vesting_milestones (
          id,
          milestone_type,
          sequence_order,
          vesting_percentage,
          months_from_start,
          performance_metric_id,
          target_value
        )
      `).eq("id",d).eq("is_template",!0).single();if(c)throw c;if(!u)throw new Error("Template not found");const{data:g,error:T}=await q.from("grants").select(`
        *,
        incentive_plans (
          vesting_schedule_type
        )
      `).eq("id",_).single();if(T)throw T;if(!g)throw new Error("Grant not found");const o=((v=g.incentive_plans)==null?void 0:v.vesting_schedule_type)||"time_based";let e=(u.vesting_milestones||[]).slice().sort((t,s)=>(t.sequence_order||0)-(s.sequence_order||0));const n=u.total_duration_months||48,r=u.cliff_months||12,a=u.vesting_frequency==="monthly"?1:u.vesting_frequency==="quarterly"?3:12,h=n-r,E=m?Math.ceil(h/a):Math.floor(h/a),F=(r>0?1:0)+E,x=e.length>0&&(e.some(t=>t.months_from_start===null||t.months_from_start===void 0||t.months_from_start===0)||e.length>1&&new Set(e.map(t=>t.months_from_start)).size===1),S=e.length>0&&e.length!==F,P=x||S;if(e.length===0||P){if(P&&e.length>0){console.warn(S?`âš ï¸ Template has incorrect number of milestones (${e.length} found, ${F} expected for ${m?"even":"percentage-based"} distribution), regenerating them`:"âš ï¸ Template has invalid milestones (missing, zero, or duplicate months_from_start), regenerating them from template settings");try{const{error:M}=await q.from("vesting_milestones").delete().eq("vesting_schedule_id",d);if(M)throw console.error("âŒ Error deleting invalid milestones:",M),M;console.log("âœ… Deleted invalid/incorrect milestones from database")}catch(M){throw console.error("âŒ Could not delete invalid milestones:",M),new Error(`Failed to delete existing milestones: ${M}`)}}else e.length===0&&console.log("â„¹ï¸ Template has no milestones, generating them from template settings");const t=u.schedule_type||"time_based",s=t==="time_based"?"time":t==="performance_based"?"performance":"hybrid";let f=0;const l=[];r>0&&l.push({milestone_type:s,sequence_order:f++,vesting_percentage:25,months_from_start:r,performance_metric_id:null,target_value:null});const w=75/E;for(let M=1;M<=E;M++){const V=r+M*a;V<=n&&l.push({milestone_type:s,sequence_order:f++,vesting_percentage:w,months_from_start:V,performance_metric_id:null,target_value:null})}if((l.length>0?l[l.length-1].months_from_start:r)<n&&E>0){const M=l[l.length-1];M&&M.months_from_start!==n&&(M.months_from_start=n)}e=l,console.log(`âœ… Generated ${e.length} milestones for template (expected: ${F})`);try{const M=e.map(G=>({vesting_schedule_id:d,milestone_type:G.milestone_type,sequence_order:G.sequence_order,vesting_percentage:G.vesting_percentage,months_from_start:G.months_from_start,performance_metric_id:G.performance_metric_id,target_value:G.target_value})),{error:V}=await q.from("vesting_milestones").insert(M);if(V)throw console.error("âŒ Error saving milestones to database:",V),V;console.log(`âœ… Saved ${e.length} generated milestones to database`)}catch(M){throw console.error("âŒ Could not save milestones to database:",M),new Error(`Failed to save generated milestones: ${M}`)}}let p=0;const i=e.map((t,s)=>{if(s===e.length-1)return Math.max(0,Number(g.total_shares)-p);if(m){const l=Number(g.total_shares)-p,w=e.length-s,B=Math.floor(l/w);return p+=B,B}else{const l=O(Number(g.total_shares),Number(t.vesting_percentage));return p+=l,l}}),y=e.filter(t=>t.months_from_start===null||t.months_from_start===void 0||t.months_from_start===0);if(y.length>0)throw console.error("âš ï¸ Found invalid milestones with null/zero months_from_start:",y),new Error(`Invalid milestones found: ${y.length} milestone(s) have null, undefined, or zero months_from_start`);new Set(e.map(t=>t.months_from_start)).size===1&&e.length>1&&console.warn("âš ï¸ All milestones have the same months_from_start value, this may indicate invalid data");let C=0;const $=e.map((t,s)=>{if(t.months_from_start===null||t.months_from_start===void 0)throw new Error(`Invalid milestone at index ${s}: months_from_start is null or undefined for sequence ${t.sequence_order}`);const f=Y(g.vesting_start_date,t.months_from_start),l=i[s];C+=l;let w;return s===0&&t.vesting_percentage===25?w="cliff":o==="performance_based"?w="performance":o==="hybrid"?w="time_based":w=o,{grant_id:_,employee_id:g.employee_id,company_id:g.company_id,event_type:w,sequence_number:t.sequence_order,vesting_date:f,shares_to_vest:l,cumulative_shares_vested:C,performance_condition_met:!0,status:"pending",created_at:new Date().toISOString()}}),{error:D}=await q.from("vesting_events").insert($);if(D)throw D;console.log(`Generated ${$.length} vesting records for grant ${_}`)}catch(u){throw console.error("Error generating individual vesting records:",u),u}},U=async(_,d,m,v,u=!1)=>{var c,g,T;try{const{data:o,error:e}=await q.from("grants").select(`
        *,
        incentive_plans (
          vesting_schedule_template_id,
          vesting_config,
          vesting_schedule_type
        )
      `).eq("id",_).single();if(e)throw e;if(!o)throw new Error("Grant not found");let n=d;o.vesting_schedule_id?(n=o.vesting_schedule_id,console.log("ðŸ“Œ Using grant's saved vesting_schedule_id:",n)):d&&(n=d,console.log("ðŸ“Œ Using provided scheduleId:",n));let r=null;if(n){const{data:t,error:s}=await q.from("vesting_schedules").select("*").eq("id",n).single();!s&&t&&(r=t,console.log("âœ… Found schedule:",t.name,`(${t.total_duration_months} months, ${t.cliff_months} month cliff, ${t.vesting_frequency})`))}if(!r&&((c=o.incentive_plans)!=null&&c.vesting_schedule_template_id)){const{data:t,error:s}=await q.from("vesting_schedules").select("*").eq("id",o.incentive_plans.vesting_schedule_template_id).eq("is_template",!0).single();!s&&t&&(r=t,console.log("âœ… Using plan template:",t.name))}let a=48,h=12,E=12;if(r){a=r.total_duration_months||48,h=r.cliff_months||12;const t=r.vesting_frequency||"annually";E=t==="monthly"?1:t==="quarterly"?3:12}else if((g=o.incentive_plans)!=null&&g.vesting_config){const t=o.incentive_plans.vesting_config;a=(t.years||4)*12,h=t.cliff_months||12;const s=t.frequency||"annually";E=s==="monthly"?1:s==="quarterly"?3:12}const F=new Date(v);let x=0,S=0;const P=a-h,p=u?Math.ceil(P/E):Math.floor(P/E);let i=0,y=0;u?h>0?(i=Math.floor(m/(p+1)),y=Math.floor((m-i)/p)):y=Math.floor(m/p):h>0?(i=Math.floor(m*.25),y=Math.floor((m-i)/p)):y=Math.floor(m/p);const b=[];let C=1;if(h>0&&i>0){const t=new Date(F);t.setMonth(t.getMonth()+h),S=i,x=i,b.push({grant_id:_,employee_id:o.employee_id,company_id:o.company_id,event_type:"cliff",sequence_number:C++,vesting_date:t.toISOString().split("T")[0],shares_to_vest:i,cumulative_shares_vested:S,performance_condition_met:!0,status:"pending",created_at:new Date().toISOString()})}for(let t=1;t<=p;t++){const s=new Date(F);s.setMonth(s.getMonth()+h+t*E);let f;t===p?f=m-x:f=y,x+=f,S=x;const l=((T=o.incentive_plans)==null?void 0:T.vesting_schedule_type)||"time_based";let w;l==="performance_based"?w="performance":w="time_based",b.push({grant_id:_,employee_id:o.employee_id,company_id:o.company_id,event_type:w,sequence_number:C++,vesting_date:s.toISOString().split("T")[0],shares_to_vest:f,cumulative_shares_vested:S,performance_condition_met:!0,status:"pending",created_at:new Date().toISOString()})}console.log("ðŸ—‘ï¸ Deleting any existing vesting events for grant:",_);const{error:$}=await q.from("vesting_events").delete().eq("grant_id",_);$?console.warn("âš ï¸ Could not delete existing vesting events (may not exist):",$):console.log("âœ… Deleted existing vesting events"),console.log(`ðŸ“ Inserting ${b.length} vesting events...`);const{error:D}=await q.from("vesting_events").insert(b);if(D){if(console.error("âŒ Error inserting vesting events:",D),D.code==="42501"){const t=new Error("RLS policy violation: Cannot insert vesting events");throw t.code="42501",t}throw D}console.log(`âœ… Generated ${b.length} vesting events using preview logic (expected: ${h>0?1:0} cliff + ${p} periods = ${(h>0?1:0)+p} total)`),console.log("ðŸ“Š Event breakdown:",{cliffEvents:h>0&&i>0?1:0,regularEvents:p,totalEvents:b.length,totalShares:m,cliffShares:i,sharesPerPeriod:y,totalPeriods:p})}catch(o){throw console.error("âŒ Error generating vesting events from preview logic:",o),o}},Y=(_,d)=>{const m=new Date(_),v=new Date(m);return v.setMonth(v.getMonth()+d),v.toISOString().split("T")[0]},O=(_,d)=>Math.floor(_*d/100),R=async _=>{var d,m;try{const{data:v,error:u}=await q.from("grants").select(`
        *,
        incentive_plans (
          vesting_schedule_template_id,
          vesting_config,
          vesting_schedule_type
        )
      `).eq("id",_).single();if(u)throw u;if(!v)return null;const c=v.incentive_plans,{data:g,error:T}=await q.from("vesting_events").select("event_type").eq("grant_id",_);T&&console.error("Error loading vesting events for grant:",T);const o=((d=g==null?void 0:g.find(a=>a.event_type&&a.event_type!=="cliff"))==null?void 0:d.event_type)||((m=g==null?void 0:g[0])==null?void 0:m.event_type)||null;let e=null;if(v.vesting_schedule_id){const{data:a,error:h}=await q.from("vesting_schedules").select("*").eq("id",v.vesting_schedule_id).single();!h&&a&&(e=a)}if(!e&&(c!=null&&c.vesting_schedule_template_id)){const{data:a,error:h}=await q.from("vesting_schedules").select("*").eq("id",c.vesting_schedule_template_id).eq("is_template",!0).single();!h&&a&&(e=a)}if(e)return{cliffMonths:e.cliff_months||12,vestingFrequency:e.vesting_frequency||"annually",vestingYears:Math.floor((e.total_duration_months||60)/12),vestingType:o||e.schedule_type||"time_based",cliffDate:Y(v.vesting_start_date,e.cliff_months||12)};const n=(c==null?void 0:c.vesting_config)||{},r=n.years||4;return{cliffMonths:n.cliff_months||12,vestingFrequency:n.frequency||"annually",vestingYears:r,vestingType:o||(c==null?void 0:c.vesting_schedule_type)||"time_based",cliffDate:Y(v.vesting_start_date,n.cliff_months||12)}}catch(v){return console.error("Error getting grant vesting details:",v),null}},A=async _=>{if(!_||_.length===0)return{};try{const{data:d,error:m}=await q.from("grants").select(`
        id,
        vesting_start_date,
        vesting_end_date,
        incentive_plans (
          vesting_schedule_template_id,
          vesting_config,
          vesting_schedule_type
        )
      `).in("id",_);if(m)throw m;if(!d||d.length===0)return{};const{data:v,error:u}=await q.from("vesting_events").select("grant_id, event_type, vesting_date, sequence_number").in("grant_id",_).order("vesting_date",{ascending:!0});u&&console.error("Error loading vesting events:",u);const c=new Map;(v||[]).forEach(e=>{c.has(e.grant_id)||c.set(e.grant_id,[]),c.get(e.grant_id).push(e)}),c.forEach((e,n)=>{e.sort((r,a)=>(r.sequence_number||0)-(a.sequence_number||0))});const g=Array.from(new Set(d.map(e=>{var n;return(n=e.incentive_plans)==null?void 0:n.vesting_schedule_template_id}).filter(e=>!!e))),T=new Map;if(g.length>0){const{data:e,error:n}=await q.from("vesting_schedules").select("*").in("id",g).eq("is_template",!0);n?console.error("Error loading templates:",n):(e||[]).forEach(r=>{T.set(r.id,r)})}const o={};return d.forEach(e=>{var E,F,x,S,P,p;const n=e.incentive_plans,r=c.get(e.id)||[];if(r.length>0&&e.vesting_start_date){const i=new Date(e.vesting_start_date),y=[...r].sort((s,f)=>{const l=new Date(s.vesting_date),w=new Date(f.vesting_date);return l.getTime()-w.getTime()}),b=new Date(y[0].vesting_date),C=Math.round((b.getTime()-i.getTime())/(1e3*60*60*24*30.44));let $="monthly";if(y.length>1){const s=y.filter(f=>f.event_type!=="cliff"||f.sequence_number>1);if(s.length>1){const f=new Date(s[0].vesting_date),l=new Date(s[1].vesting_date),w=Math.round((l.getTime()-f.getTime())/(1e3*60*60*24*30.44));w>=12?$="annually":w>=3?$="quarterly":$="monthly"}}let D=4;if(e.vesting_end_date){const s=new Date(e.vesting_end_date),f=Math.round((s.getTime()-i.getTime())/(1e3*60*60*24*30.44));D=Math.round(f/12)}else if(y.length>0){const s=new Date(y[y.length-1].vesting_date),f=Math.round((s.getTime()-i.getTime())/(1e3*60*60*24*30.44));D=Math.round(f/12)}const t=((E=r.find(s=>s.event_type&&s.event_type!=="cliff"))==null?void 0:E.event_type)||((F=r[0])==null?void 0:F.event_type)||"time_based";o[e.id]={cliffMonths:Math.max(0,C),vestingFrequency:$,vestingYears:Math.max(1,D),vestingType:t==="cliff"?"time_based":t||"time_based",cliffDate:Y(e.vesting_start_date,Math.max(0,C))};return}if(n!=null&&n.vesting_schedule_template_id){const i=T.get(n.vesting_schedule_template_id);if(i){const y=((x=r.find(b=>b.event_type&&b.event_type!=="cliff"))==null?void 0:x.event_type)||((S=r[0])==null?void 0:S.event_type)||null;o[e.id]={cliffMonths:i.cliff_months||12,vestingFrequency:i.vesting_frequency||"monthly",vestingYears:Math.floor((i.total_duration_months||48)/12),vestingType:y||i.schedule_type||"time_based",cliffDate:Y(e.vesting_start_date,i.cliff_months||12)};return}}const a=(n==null?void 0:n.vesting_config)||{},h=((P=r.find(i=>i.event_type&&i.event_type!=="cliff"))==null?void 0:P.event_type)||((p=r[0])==null?void 0:p.event_type)||null;o[e.id]={cliffMonths:a.cliff_months||12,vestingFrequency:a.frequency||"monthly",vestingYears:a.years||4,vestingType:h||(n==null?void 0:n.vesting_schedule_type)||"time_based",cliffDate:Y(e.vesting_start_date,a.cliff_months||12)}}),o}catch(d){return console.error("Error getting batch grant vesting details:",d),{}}};export{U as a,N as b,A as c,R as g};
