import{s as x,j as e}from"./index-DDk1oefv.js";import{r as m}from"./react-vendor-xiFAdxLt.js";import{f as O}from"./dateUtils-DoPl8O0G.js";import{B as G,c as q,D as z,C as H,q as J,l as K,O as Q,A as N,p as W}from"./ui-vendor-B0ZOy8uN.js";import"./supabase-vendor-B-LuImWU.js";function re(){const[_,E]=m.useState([]),[l,I]=m.useState({total_grants:0,total_shares:0,vested_shares:0,unvested_shares:0}),[f,v]=m.useState({total_allocated:0,total_granted:0,total_available:0}),[R,C]=m.useState(!0),[X,F]=m.useState(null),[w,V]=m.useState([]),[S,$]=m.useState(0);m.useEffect(()=>{U()},[]);const U=async()=>{try{const{data:{user:a}}=await x.auth.getUser();if(!a)return;const{data:o}=await x.from("company_users").select("company_id, companies(*)").eq("user_id",a.id).maybeSingle();if(o){F(o);const[M,g,y,Y]=await Promise.all([x.from("portfolios").select("*").eq("company_id",o.company_id),x.from("grants").select("id, total_shares, vested_shares, remaining_unvested_shares, status").eq("company_id",o.company_id),x.from("incentive_plans").select("total_shares_allocated, shares_granted").eq("company_id",o.company_id),x.from("shareholders").select("shares_owned").eq("company_id",o.company_id).eq("shareholder_type","employee").eq("is_active",!0)]);E(M.data||[]);const j=(g.data||[]).filter(t=>t.status==="active").map(t=>t.id);let p=[];if(j.length>0){const{data:t,error:r}=await x.from("vesting_events").select("grant_id, shares_to_vest, status").in("grant_id",j);r?console.warn("Error loading vesting events:",r):p=t||[]}const b={},L=["vested","transferred","exercised","due"];if(p.forEach(t=>{b[t.grant_id]||(b[t.grant_id]=0),L.includes(t.status)&&(b[t.grant_id]+=Math.floor(Number(t.shares_to_vest||0)))}),g.data){const t=g.data,r=t.filter(i=>i.status==="active"),n=t.reduce((i,h)=>i+Math.floor(Number(h.total_shares||0)),0),d=r.reduce((i,h)=>{const k=Number(h.total_shares||0),D=b[h.id]||0,A=Math.min(D,k),B=Math.max(0,k-A);return{total_grants:i.total_grants+1,vested_shares:i.vested_shares+A,unvested_shares:i.unvested_shares+B}},{total_grants:0,vested_shares:0,unvested_shares:0});console.log("ðŸ“Š Portfolio Calculation Debug:"),console.log("All grants (total):",t.length),console.log("Active grants:",r.length),console.log("Active grant IDs:",j),console.log("Vesting events found:",(p==null?void 0:p.length)||0),console.log("Vested shares by grant:",b),console.log("Vested statuses used:",L);const c={};p.forEach(i=>{const h=i.status||"unknown";c[h]=(c[h]||0)+Math.floor(Number(i.shares_to_vest||0))}),console.log("Status breakdown (shares per status):",c);const T={total_grants:d.total_grants,total_shares:n,vested_shares:d.vested_shares,unvested_shares:d.unvested_shares};console.log("Final summary:",T),console.log("Total granted (all grants):",n),console.log("Vested (active grants only):",d.vested_shares),console.log("Unvested (active grants only):",d.unvested_shares),I(T)}const{data:u}=await x.from("ltip_pools").select("total_shares_allocated").eq("company_id",o.company_id).eq("status","active");if(u){const t=u.reduce((r,n)=>r+Number(n.total_shares_allocated||0),0);$(t)}if(g.data&&g.data.length>0){const t=g.data.reduce((d,c)=>d+Number(c.total_shares||0),0);let r=(u==null?void 0:u.reduce((d,c)=>d+Number(c.total_shares_allocated||0),0))||0;r===0&&y.data&&(r=y.data.reduce((d,c)=>d+Number(c.total_shares_allocated||0),0));const n={total_allocated:r,total_granted:t,total_available:r-t};v(n)}else if(y.data){const t=y.data.reduce((r,n)=>({total_allocated:r.total_allocated+Number(n.total_shares_allocated||0),total_granted:r.total_granted+Number(n.shares_granted||0),total_available:r.total_available+(Number(n.total_shares_allocated||0)-Number(n.shares_granted||0))}),{total_allocated:0,total_granted:0,total_available:0});v(t)}const{data:P}=await x.from("share_transfers").select(`
            id,
            transfer_number,
            shares_transferred,
            transfer_date,
            status,
            transfer_type,
            employees (
              first_name_en,
              last_name_en
            ),
            grants (
              grant_number
            )
          `).eq("company_id",o.company_id).order("created_at",{ascending:!1}).limit(10);P&&V(P)}}catch(a){console.error("Error loading portfolio data:",a)}finally{C(!1)}};if(R)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});const s=_.find(a=>a.portfolio_type==="company_reserved");return _.find(a=>a.portfolio_type==="employee_vested"),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Portfolio Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Track and manage share portfolios"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg",children:e.jsx(G,{className:"w-6 h-6 text-blue-600"})})}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"LTIP Pool Allocated"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:f.total_allocated.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Available: ",f.total_available.toLocaleString()]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"bg-green-100 p-3 rounded-lg",children:e.jsx(q,{className:"w-6 h-6 text-green-600"})})}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Granted Shares"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:l.total_shares.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Active Grants: ",l.total_grants]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"bg-emerald-100 p-3 rounded-lg",children:e.jsx(z,{className:"w-6 h-6 text-emerald-600"})})}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Vested Shares"}),e.jsx("p",{className:"text-2xl font-bold text-emerald-600",children:l.vested_shares.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[l.total_shares>0?(l.vested_shares/l.total_shares*100).toFixed(1):0,"% of Granted"]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"bg-amber-100 p-3 rounded-lg",children:e.jsx(H,{className:"w-6 h-6 text-amber-600"})})}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Unvested Shares"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:l.unvested_shares.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[l.total_shares>0?(l.unvested_shares/l.total_shares*100).toFixed(1):0,"% of Granted"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Grant Summary"})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total Grants Issued"}),e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:l.total_grants})]}),e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total Shares Granted"}),e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:l.total_shares.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Vested Shares"}),e.jsx("span",{className:"text-lg font-semibold text-green-600",children:l.vested_shares.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Unvested Shares"}),e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:l.unvested_shares.toLocaleString()})]})]})})]}),s&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-blue-600"}),"Company Reserved Portfolio"]}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Portfolio Number: ",s.portfolio_number]}),S>0&&e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["Synced with LTIP Pools: ",S.toLocaleString()," shares"]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${Number(s.available_shares)>0?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:Number(s.available_shares)>0?"Active":"Fully Allocated"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Shares"}),e.jsx(G,{className:"w-4 h-4 text-gray-400"})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:Number(s.total_shares).toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.total_shares>0?`${(s.total_shares/(f.total_allocated||s.total_shares)*100).toFixed(1)}% of LTIP Pool`:"No shares allocated"})]}),e.jsxs("div",{className:"bg-green-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Available"}),e.jsx(q,{className:"w-4 h-4 text-green-400"})]}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:Number(s.available_shares).toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.total_shares>0?`${(s.available_shares/s.total_shares*100).toFixed(1)}% of total`:"No shares available"})]}),e.jsxs("div",{className:"bg-amber-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Locked (Granted)"}),e.jsx(K,{className:"w-4 h-4 text-amber-400"})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:Number(s.locked_shares).toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.total_shares>0?`${(s.locked_shares/s.total_shares*100).toFixed(1)}% of total`:"No shares locked"})]})]}),s.total_shares>0&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Portfolio Allocation"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[(s.available_shares/s.total_shares*100).toFixed(1),"% Available"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 overflow-hidden",children:e.jsxs("div",{className:"flex h-full",children:[e.jsx("div",{className:"bg-green-500 transition-all duration-300",style:{width:`${s.available_shares/s.total_shares*100}%`}}),e.jsx("div",{className:"bg-amber-500 transition-all duration-300",style:{width:`${s.locked_shares/s.total_shares*100}%`}})]})}),e.jsxs("div",{className:"flex items-center justify-between mt-2 text-xs text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded"}),e.jsx("span",{children:"Available"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-amber-500 rounded"}),e.jsx("span",{children:"Locked (Granted)"})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4"}),"Share Movement Flow"]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-600",children:[e.jsx("div",{className:"flex-1 text-center",children:e.jsxs("div",{className:"bg-blue-50 rounded-lg p-3 mb-2",children:[e.jsx("p",{className:"font-semibold text-blue-900",children:"LTIP Pools"}),e.jsxs("p",{className:"text-blue-700",children:[f.total_allocated.toLocaleString()," shares"]})]})}),e.jsx(N,{className:"w-5 h-5 text-gray-400 mx-2"}),e.jsx("div",{className:"flex-1 text-center",children:e.jsxs("div",{className:"bg-purple-50 rounded-lg p-3 mb-2",children:[e.jsx("p",{className:"font-semibold text-purple-900",children:"Company Portfolio"}),e.jsxs("p",{className:"text-purple-700",children:[s.total_shares.toLocaleString()," shares"]})]})}),e.jsx(N,{className:"w-5 h-5 text-gray-400 mx-2"}),e.jsx("div",{className:"flex-1 text-center",children:e.jsxs("div",{className:"bg-green-50 rounded-lg p-3 mb-2",children:[e.jsx("p",{className:"font-semibold text-green-900",children:"Employee Grants"}),e.jsxs("p",{className:"text-green-700",children:[l.total_shares.toLocaleString()," shares"]})]})})]})]})]})]}),w.length>0&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5 text-blue-600"}),"Recent Share Transfers"]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Latest share movements from company portfolio"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Transfer #"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Employee"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Grant"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Shares"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:w.map(a=>{var o;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:a.transfer_number}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:a.employees?`${a.employees.first_name_en} ${a.employees.last_name_en}`:"N/A"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:((o=a.grants)==null?void 0:o.grant_number)||"N/A"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:Number(a.shares_transferred).toLocaleString()}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:O(a.transfer_date)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${a.status==="transferred"?"bg-green-100 text-green-800":a.status==="pending"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:a.status})})]},a.id)})})]})})]}),e.jsx("div",{className:"bg-blue-50 rounded-lg border border-blue-200 p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(W,{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-semibold text-blue-900 mb-1",children:"Portfolio Overview"}),e.jsxs("p",{className:"text-sm text-blue-800 mb-2",children:[e.jsx("strong",{children:"LTIP Pool:"})," Total shares allocated across all LTIP pools or incentive plans for employee equity grants.",e.jsx("br",{}),e.jsx("strong",{children:"Company Reserved Portfolio:"})," Automatically synced with LTIP pools, tracks total shares, available shares, and locked (granted) shares.",e.jsx("br",{}),e.jsx("strong",{children:"Granted Shares:"})," Total shares granted to employees through active equity grants (these shares are locked in the company portfolio until transferred).",e.jsx("br",{}),e.jsx("strong",{children:"Vested/Unvested:"})," Breakdown of granted shares based on vesting status."]}),e.jsxs("p",{className:"text-xs text-blue-700 mt-2",children:[e.jsx("strong",{children:"Note:"})," The Company Reserved Portfolio automatically updates when LTIP pools, incentive plans, or grants are created or modified."]})]})]})})]})}export{re as default};
