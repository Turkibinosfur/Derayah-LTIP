import{a as X,u as z,s as E,j as e}from"./index-CHcuUdej.js";import{r}from"./react-vendor-xiFAdxLt.js";import{e as C,s as p,q as u,D as G,E as R,X as V,t as k}from"./ui-vendor-a8g5-7pO.js";import"./supabase-vendor-B-LuImWU.js";function Y(){const{t:H,i18n:A}=X();A.language;const[l,M]=r.useState([]),[L,c]=r.useState(!0),[h,d]=r.useState(null),[o,g]=r.useState(null),[P,b]=r.useState(!1),[y,j]=r.useState("active"),[f,N]=r.useState(!1),[v,n]=r.useState(null),{userRole:i,isSuperAdmin:w}=z(),x=r.useMemo(()=>w()||(i==null?void 0:i.user_type)==="super_admin"||(i==null?void 0:i.role)==="super_admin",[i,w]);r.useEffect(()=>{if(!x){d("Access denied. Super admin only."),c(!1);return}S()},[x]);const S=async()=>{try{c(!0),d(null);const{data:s,error:t}=await E.from("company_subscriptions").select(`
          *,
          companies:company_id (
            company_name_en,
            company_name_ar,
            tadawul_symbol
          )
        `).order("created_at",{ascending:!1});if(t)throw t;M(s||[])}catch(s){console.error("Error loading subscriptions:",s),d("Failed to load subscriptions.")}finally{c(!1)}},D=s=>{g(s),j(s.status),n(null),b(!0)},m=()=>{g(null),n(null),b(!1)},T=async()=>{if(o)try{N(!0),n(null);const{error:s}=await E.from("company_subscriptions").update({status:y,updated_at:new Date().toISOString()}).eq("id",o.id);if(s){console.error("Error updating subscription:",s),n(`Failed to save changes: ${s.message}`);return}m(),await S()}catch(s){console.error("Error updating subscription:",s),n(`Failed to save changes: ${(s==null?void 0:s.message)||"Unknown error occurred"}`)}finally{N(!1)}},U=s=>{const t={active:{label:"Active",color:"bg-green-50 text-green-700 border-green-200",icon:p},suspended:{label:"Suspended",color:"bg-yellow-50 text-yellow-700 border-yellow-200",icon:u},cancelled:{label:"Cancelled",color:"bg-red-50 text-red-700 border-red-200",icon:k},expired:{label:"Expired",color:"bg-gray-50 text-gray-700 border-gray-200",icon:k},trial:{label:"Trial",color:"bg-blue-50 text-blue-700 border-blue-200",icon:u}};return t[s||"active"]||t.active},B=s=>({basic:"Basic",professional:"Professional",enterprise:"Enterprise",custom:"Custom"})[s];if(!x)return e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-700",children:"Access denied. Super admin only."})})});const F=l.filter(s=>s.status==="active").length,O=l.filter(s=>s.status==="trial").length;l.filter(s=>s.status==="suspended").length;const $=l.filter(s=>s.status==="active").reduce((s,t)=>s+(t.price_per_cycle||0),0);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Subscriptions Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage company subscription plans and billing"})]})}),h&&e.jsx("div",{className:"p-4 rounded-lg border border-red-200 bg-red-50 text-red-700",children:h}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total Subscriptions"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:l.length})]}),e.jsx(C,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Active"}),e.jsx("p",{className:"text-2xl font-bold text-green-600 mt-1",children:F})]}),e.jsx(p,{className:"w-8 h-8 text-green-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Trial"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600 mt-1",children:O})]}),e.jsx(u,{className:"w-8 h-8 text-yellow-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Monthly Revenue"}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$.toLocaleString()," SAR"]})]}),e.jsx(G,{className:"w-8 h-8 text-blue-600"})]})})]}),L?e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-12 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading subscriptions..."})]}):e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(C,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"All Subscriptions"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Manage company subscription plans"})]})]})}),l.length===0?e.jsx("div",{className:"p-10 text-center text-gray-500",children:"No subscriptions found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Company"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Plan"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Billing"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Price"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Next Payment"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Limits"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:l.map(s=>{var _;const t=U(s.status),q=(t==null?void 0:t.icon)||p,a=s.companies;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:(a==null?void 0:a.company_name_en)||"N/A"}),e.jsx("div",{className:"text-sm text-gray-500",dir:"rtl",children:(a==null?void 0:a.company_name_ar)||""}),(a==null?void 0:a.tadawul_symbol)&&e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:a.tadawul_symbol})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700",children:B(s.subscription_plan)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${(t==null?void 0:t.color)||"bg-gray-50 text-gray-700 border-gray-200"}`,children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),(t==null?void 0:t.label)||"Unknown"]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.billing_cycle.charAt(0).toUpperCase()+s.billing_cycle.slice(1)}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:[((_=s.price_per_cycle)==null?void 0:_.toLocaleString())||0," ",s.currency]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.next_payment_date?new Date(s.next_payment_date).toLocaleDateString("en-GB"):"N/A"}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:e.jsxs("div",{className:"text-xs",children:[s.max_employees&&e.jsxs("div",{children:["Employees: ",s.max_employees]}),s.max_plans&&e.jsxs("div",{children:["Plans: ",s.max_plans]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm",children:e.jsx("button",{onClick:()=>D(s),className:"p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":"Actions for subscription",children:e.jsx(R,{className:"w-5 h-5 text-gray-500"})})})]},s.id)})})]})})]}),P&&o&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Update Subscription"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Change subscription status"})]}),e.jsx("button",{onClick:m,className:"text-gray-400 hover:text-gray-600","aria-label":"Close edit modal",children:e.jsx(V,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-5 space-y-5",children:[v&&e.jsx("div",{className:"p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 text-sm",children:v}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("select",{value:y,onChange:s=>j(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"suspended",children:"Suspended"}),e.jsx("option",{value:"cancelled",children:"Cancelled"}),e.jsx("option",{value:"expired",children:"Expired"}),e.jsx("option",{value:"trial",children:"Trial"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsx("button",{onClick:m,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800",type:"button",children:"Cancel"}),e.jsx("button",{onClick:T,disabled:f,className:"px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",type:"button",children:f?"Saving...":"Save Changes"})]})]})})]})}export{Y as default};
