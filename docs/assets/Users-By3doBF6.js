import{a as Me,b as Pe,u as Ie,s as x,j as e}from"./index-CHcuUdej.js";import{r}from"./react-vendor-xiFAdxLt.js";import{U as Le,E as Ue,X as he}from"./ui-vendor-a8g5-7pO.js";import"./supabase-vendor-B-LuImWU.js";const be=["company_admin","super_admin","finance_admin","legal_admin","hr_admin","viewer"],c=[{key:"dashboard",label:"Overview"},{key:"users",label:"Users"},{key:"employees",label:"Employees"},{key:"ltip_pools",label:"LTIP Pools"},{key:"plans",label:"Incentive Plans"},{key:"vesting_schedules",label:"Vesting Schedules"},{key:"vesting_events",label:"Vesting Events"},{key:"transfers",label:"Transfers"},{key:"performance_metrics",label:"Performance Metrics"},{key:"grants",label:"Grants"},{key:"documents",label:"Documents"},{key:"contract_approval",label:"Contract Approvals"},{key:"cap_table",label:"Cap Table"},{key:"portfolio",label:"Portfolio"},{key:"settings",label:"Settings"}],p=f=>c.reduce((j,u)=>(j[u.key]=!!(f!=null&&f[u.key]),j),{});function ze(){const{t:f,i18n:j}=Me(),u=j.language==="ar",{brandColor:l}=Pe(),[U,T]=r.useState([]),[Te,ye]=r.useState({}),[fe,N]=r.useState(!0),[R,g]=r.useState(null),[h,$]=r.useState(null),[D,q]=r.useState("finance_admin"),[A,F]=r.useState(!0),[z,B]=r.useState(!1),[V,m]=r.useState(null),[b,G]=r.useState(null),[J,O]=r.useState(""),[H,X]=r.useState(""),[K,v]=r.useState(()=>p()),[je,Q]=r.useState(!1),[W,Y]=r.useState(""),[Z,ee]=r.useState("finance_admin"),[C,se]=r.useState(!0),[te,o]=r.useState(null),[re,ae]=r.useState(!1),[le,ne]=r.useState(""),[ie,de]=r.useState(""),[oe,w]=r.useState(()=>p()),{user:Re,getCurrentCompanyId:Ne,userRole:k,loading:ce,onboardingLoaded:ue}=Ie(),E=Ne(),me=r.useMemo(()=>(k==null?void 0:k.user_type)==="super_admin",[k]);r.useEffect(()=>{if(!E){if(ce||!ue){N(!0),g(null);return}G(null),T([]),g(me?"Select a company to manage administrators.":"No company associated with the current user."),N(!1);return}S(E)},[E,me,ce,ue]);const S=async s=>{try{N(!0),g(null),G(s);const{data:t,error:a}=await x.from("company_users").select(`
          id,
          role,
          is_active,
          permissions,
          created_at,
          user_id,
          display_name_en,
          display_name_ar
        `).eq("company_id",s).neq("role","super_admin").order("created_at",{ascending:!0});if(a)throw a;const i=t||[],_=i.map(n=>n.user_id),y=Array.from(new Set(_)),L={};if(y.length>0){const{data:n,error:d}=await x.from("company_admin_users_view").select("id, email").in("id",y);if(d)throw d;(n||[]).forEach(ge=>{L[ge.id]=ge})}ye(L);const Se=i.map(n=>{const d=L[n.user_id];return{id:n.id,userId:n.user_id,email:(d==null?void 0:d.email)??null,name:n.display_name_en||n.display_name_ar||(d==null?void 0:d.email)||null,nameEn:n.display_name_en??null,nameAr:n.display_name_ar??null,rawRole:n.role,isActive:!!n.is_active,permissions:p(n.permissions??null),createdAt:n.created_at}});T(Se)}catch(t){console.error("Error loading users:",t),g("Failed to load users.")}finally{N(!1)}},ve=s=>{const t=c.filter(a=>s[a.key]);return t.length===c.length?e.jsx("span",{className:"text-sm text-green-700",children:"Full access to all modules"}):t.length===0?e.jsx("span",{className:"text-sm text-gray-500",children:"No modules enabled"}):e.jsx("div",{className:"flex flex-wrap gap-2",children:t.map(a=>e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200",children:a.label},a.key))})},we=s=>{$(s),q(s.rawRole??"finance_admin"),F(s.isActive),O(s.nameEn||""),X(s.nameAr||""),v({...s.permissions}),m(null)},M=()=>{$(null),m(null),v(p())},ke=async()=>{if(h)try{B(!0),m(null);const{error:s,data:t}=await x.from("company_users").update({role:D,is_active:A,display_name_en:J.trim()||null,display_name_ar:H.trim()||null,permissions:K}).eq("id",h.id).select();if(s){console.error("Error updating user:",s),m(`Failed to save changes: ${s.message||"Permission denied. Please ensure you have admin privileges."}`);return}if(!t||t.length===0){m("Update completed but no data returned. This may indicate a permissions issue.");return}M(),await S(b)}catch(s){console.error("Error updating user:",s),m(`Failed to save changes: ${(s==null?void 0:s.message)||"Unknown error occurred"}`)}finally{B(!1)}},P=s=>s?s.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase()):"Unknown",_e=s=>{v(t=>({...t,[s]:!t[s]}))},Ae=s=>{w(t=>({...t,[s]:!t[s]}))},xe=s=>{v(t=>{const a={...t};return c.forEach(i=>{a[i.key]=s}),a})},pe=s=>{w(t=>{const a={...t};return c.forEach(i=>{a[i.key]=s}),a})},Ce=()=>{Y(""),ee("finance_admin"),se(!0),ne(""),de(""),w(p()),o(null),Q(!0)},I=()=>{Q(!1),o(null),w(p())},Ee=async()=>{if(!b){o("Missing company reference. Please refresh and try again.");return}const s=W.trim().toLowerCase();if(!s){o("Please enter an email address.");return}try{ae(!0),o(null);const{data:t,error:a}=await x.from("company_admin_users_view").select("id, email").eq("email",s).maybeSingle();if(a)throw a;if(!t){o("No Supabase user found with that email. Create the account first.");return}const{data:i,error:_}=await x.from("company_users").select("id").eq("company_id",b).eq("user_id",t.id).maybeSingle();if(_)throw _;if(i){o("This user is already linked to the company.");return}const{error:y}=await x.from("company_users").insert({company_id:b,user_id:t.id,role:Z,is_active:C,display_name_en:le.trim()||null,display_name_ar:ie.trim()||null,permissions:oe});if(y)throw y;I(),await S(b)}catch(t){console.error("Error adding company user:",t),o("Failed to add user.")}finally{ae(!1)}};return e.jsxs("div",{className:`space-y-6 ${u?"text-right":"text-left"}`,dir:u?"rtl":"ltr",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:u?"text-right":"",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Company Users"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage administrative users and review their permissions."})]}),e.jsx("button",{onClick:Ce,className:"inline-flex items-center px-4 py-2 text-white text-sm font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 transition",style:{backgroundColor:l},onMouseEnter:s=>{const t=parseInt(l.slice(1,3),16)*.9,a=parseInt(l.slice(3,5),16)*.9,i=parseInt(l.slice(5,7),16)*.9;s.currentTarget.style.backgroundColor=`rgb(${Math.round(t)}, ${Math.round(a)}, ${Math.round(i)})`,s.currentTarget.style.setProperty("--tw-ring-color",l)},onMouseLeave:s=>{s.currentTarget.style.backgroundColor=l},onFocus:s=>{s.currentTarget.style.setProperty("--tw-ring-color",l)},children:"Add User"})]}),R&&e.jsx("div",{className:"p-4 rounded-lg border border-red-200 bg-red-50 text-red-700",children:R}),fe?e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-12 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading users..."})]}):e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(Le,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Administrative Users"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Super Admins, Finance Admins, Legal Admins, and HR Admins"})]})]})}),U.length===0?e.jsx("div",{className:"p-10 text-center text-gray-500",children:"No administrative users found for this company."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"User"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Role"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Permissions"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Added On"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:U.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.name||s.email||s.userId}),e.jsx("div",{className:"text-sm text-gray-500",children:s.email||s.userId})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 capitalize",children:P(s.rawRole)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${s.isActive?"bg-green-50 text-green-700":"bg-gray-100 text-gray-500"}`,children:s.isActive?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-4",children:ve(s.permissions)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.createdAt?new Date(s.createdAt).toLocaleDateString("en-GB"):"N/A"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm",children:e.jsx("button",{onClick:()=>we(s),className:"p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":`Actions for ${s.email||s.userId}`,children:e.jsx(Ue,{className:"w-5 h-5 text-gray-500"})})})]},s.id))})]})})]}),h&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit User"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Update role and status for ",h.email||h.userId]})]}),e.jsx("button",{onClick:M,className:"text-gray-400 hover:text-gray-600","aria-label":"Close edit modal",children:e.jsx(he,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-5 space-y-5",children:[V&&e.jsx("div",{className:"p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 text-sm",children:V}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),e.jsx("select",{value:D,onChange:s=>q(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:be.map(s=>e.jsx("option",{value:s,children:P(s)},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"text-sm text-gray-500",children:A?"Active":"Inactive"}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:A,onChange:s=>F(s.target.checked)}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Display Name (English)"}),e.jsx("input",{type:"text",value:J,onChange:s=>O(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"John Doe"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Display Name (Arabic)"}),e.jsx("input",{type:"text",value:H,onChange:s=>X(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right",placeholder:"جون دو",dir:"rtl"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Module Permissions"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("button",{type:"button",onClick:()=>xe(!0),className:"text-blue-600 hover:text-blue-800",children:"Select all"}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsx("button",{type:"button",onClick:()=>xe(!1),className:"text-blue-600 hover:text-blue-800",children:"Clear all"})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:c.map(s=>e.jsxs("label",{className:"flex items-center space-x-2 rounded-lg border border-gray-200 px-3 py-2 hover:border-blue-300",children:[e.jsx("input",{type:"checkbox",checked:K[s.key],onChange:()=>_e(s.key),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:s.label})]},s.key))})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsx("button",{onClick:M,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800",type:"button",children:"Cancel"}),e.jsx("button",{onClick:ke,disabled:z,className:"px-5 py-2 text-sm font-semibold text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition",style:{backgroundColor:l},onMouseEnter:s=>{if(!s.currentTarget.disabled){const t=parseInt(l.slice(1,3),16)*.9,a=parseInt(l.slice(3,5),16)*.9,i=parseInt(l.slice(5,7),16)*.9;s.currentTarget.style.backgroundColor=`rgb(${Math.round(t)}, ${Math.round(a)}, ${Math.round(i)})`}},onMouseLeave:s=>{s.currentTarget.style.backgroundColor=l},type:"button",children:z?"Saving...":"Save Changes"})]})]})}),je&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Add Company User"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Link an existing Supabase user to this company with an admin role."})]}),e.jsx("button",{onClick:I,className:"text-gray-400 hover:text-gray-600","aria-label":"Close add modal",children:e.jsx(he,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-5 space-y-5",children:[te&&e.jsx("div",{className:"p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 text-sm",children:te}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"User Email"}),e.jsx("input",{type:"email",value:W,onChange:s=>Y(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"name@example.com"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"The user must already exist in Supabase authentication."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),e.jsx("select",{value:Z,onChange:s=>ee(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:be.map(s=>e.jsx("option",{value:s,children:P(s)},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"text-sm text-gray-500",children:C?"Active":"Inactive"}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:C,onChange:s=>se(s.target.checked)}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Display Name (English)"}),e.jsx("input",{type:"text",value:le,onChange:s=>ne(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"John Doe"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Display Name (Arabic)"}),e.jsx("input",{type:"text",value:ie,onChange:s=>de(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right",placeholder:"جون دو",dir:"rtl"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Module Permissions"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("button",{type:"button",onClick:()=>pe(!0),className:"text-blue-600 hover:text-blue-800",children:"Select all"}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsx("button",{type:"button",onClick:()=>pe(!1),className:"text-blue-600 hover:text-blue-800",children:"Clear all"})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:c.map(s=>e.jsxs("label",{className:"flex items-center space-x-2 rounded-lg border border-gray-200 px-3 py-2 hover:border-blue-300",children:[e.jsx("input",{type:"checkbox",checked:oe[s.key],onChange:()=>Ae(s.key),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:s.label})]},s.key))})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsx("button",{onClick:I,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800",type:"button",children:"Cancel"}),e.jsx("button",{onClick:Ee,disabled:re,className:"px-5 py-2 text-sm font-semibold text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition",style:{backgroundColor:l},onMouseEnter:s=>{if(!s.currentTarget.disabled){const t=parseInt(l.slice(1,3),16)*.9,a=parseInt(l.slice(3,5),16)*.9,i=parseInt(l.slice(5,7),16)*.9;s.currentTarget.style.backgroundColor=`rgb(${Math.round(t)}, ${Math.round(a)}, ${Math.round(i)})`}},onMouseLeave:s=>{s.currentTarget.style.backgroundColor=l},type:"button",children:re?"Saving...":"Add User"})]})]})})]})}export{ze as default};
