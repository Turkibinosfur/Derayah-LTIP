import{a as U,u as V,s as g,j as e}from"./index-CHcuUdej.js";import{r as a}from"./react-vendor-xiFAdxLt.js";import{a8 as E,q as b,s as y,D as X,E as z,X as G,t as R}from"./ui-vendor-a8g5-7pO.js";import"./supabase-vendor-B-LuImWU.js";function Y(){const{t:H,i18n:D}=U();D.language;const[l,M]=a.useState([]),[L,p]=a.useState(!0),[j,m]=a.useState(null),[r,f]=a.useState(null),[B,N]=a.useState(!1),[o,v]=a.useState("pending"),[w,_]=a.useState(!1),[S,c]=a.useState(null),{userRole:d,isSuperAdmin:k}=V(),u=a.useMemo(()=>k()||(d==null?void 0:d.user_type)==="super_admin"||(d==null?void 0:d.role)==="super_admin",[d,k]);a.useEffect(()=>{if(!u){m("Access denied. Super admin only."),p(!1);return}A()},[u]);const A=async()=>{try{p(!0),m(null);const{data:t,error:s}=await g.from("buyback_requests").select(`
          *,
          companies:company_id (
            company_name_en,
            company_name_ar,
            tadawul_symbol
          ),
          employees:employee_id (
            first_name_en,
            last_name_en,
            employee_number
          )
        `).order("created_at",{ascending:!1});if(s)throw s;M(t||[])}catch(t){console.error("Error loading buyback requests:",t),m("Failed to load buyback requests.")}finally{p(!1)}},P=t=>{f(t),v(t.status),c(null),N(!0)},h=()=>{f(null),c(null),N(!1)},$=async()=>{var t;if(r)try{_(!0),c(null);const s={status:o,updated_at:new Date().toISOString()};o==="approved"&&r.status!=="approved"&&(s.approved_by=(t=(await g.auth.getUser()).data.user)==null?void 0:t.id,s.approved_at=new Date().toISOString()),o==="completed"&&r.actual_price_per_share&&(s.total_amount=r.shares_requested*r.actual_price_per_share,s.completion_date=new Date().toISOString().split("T")[0]);const{error:i}=await g.from("buyback_requests").update(s).eq("id",r.id);if(i){console.error("Error updating buyback request:",i),c(`Failed to save changes: ${i.message}`);return}h(),await A()}catch(s){console.error("Error updating buyback request:",s),c(`Failed to save changes: ${(s==null?void 0:s.message)||"Unknown error occurred"}`)}finally{_(!1)}},I=t=>({pending:{label:"Pending",color:"bg-yellow-50 text-yellow-700 border-yellow-200",icon:b},approved:{label:"Approved",color:"bg-blue-50 text-blue-700 border-blue-200",icon:y},rejected:{label:"Rejected",color:"bg-red-50 text-red-700 border-red-200",icon:R},processing:{label:"Processing",color:"bg-purple-50 text-purple-700 border-purple-200",icon:b},completed:{label:"Completed",color:"bg-green-50 text-green-700 border-green-200",icon:y},cancelled:{label:"Cancelled",color:"bg-gray-50 text-gray-700 border-gray-200",icon:R}})[t];if(!u)return e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-700",children:"Access denied. Super admin only."})})});const O=l.filter(t=>t.status==="pending").length,T=l.filter(t=>t.status==="approved").length;l.filter(t=>t.status==="completed").length;const F=l.filter(t=>t.status==="completed"&&t.total_amount).reduce((t,s)=>t+(s.total_amount||0),0);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Buyback Requests"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage employee share buyback requests"})]})}),j&&e.jsx("div",{className:"p-4 rounded-lg border border-red-200 bg-red-50 text-red-700",children:j}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total Requests"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:l.length})]}),e.jsx(E,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600 mt-1",children:O})]}),e.jsx(b,{className:"w-8 h-8 text-yellow-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Approved"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:T})]}),e.jsx(y,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total Completed Value"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600 mt-1",children:[F.toLocaleString()," SAR"]})]}),e.jsx(X,{className:"w-8 h-8 text-green-600"})]})})]}),L?e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-12 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading buyback requests..."})]}):e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(E,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"All Buyback Requests"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Review and manage share buyback requests"})]})]})}),l.length===0?e.jsx("div",{className:"p-10 text-center text-gray-500",children:"No buyback requests found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Request #"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Company"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Employee"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Shares"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Price/Share"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total Amount"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Request Date"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:l.map(t=>{var C;const s=I(t.status),i=s.icon,n=t.companies,x=t.employees,q=t.total_amount||(t.requested_price_per_share?t.shares_requested*t.requested_price_per_share:null);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.request_number}),e.jsx("div",{className:"text-xs text-gray-500",children:t.request_type})]}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:(n==null?void 0:n.company_name_en)||"N/A"}),(n==null?void 0:n.tadawul_symbol)&&e.jsx("div",{className:"text-xs text-gray-500",children:n.tadawul_symbol})]}),e.jsx("td",{className:"px-6 py-4",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[x.first_name_en," ",x.last_name_en]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["#",x.employee_number]})]}):e.jsx("span",{className:"text-sm text-gray-400",children:"N/A"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:t.shares_requested.toLocaleString()}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.actual_price_per_share||t.requested_price_per_share?`${(C=t.actual_price_per_share||t.requested_price_per_share)==null?void 0:C.toLocaleString()} SAR`:"N/A"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:q?`${q.toLocaleString()} SAR`:"N/A"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${s.color}`,children:[e.jsx(i,{className:"w-3 h-3 mr-1"}),s.label]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(t.request_date).toLocaleDateString("en-GB")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm",children:e.jsx("button",{onClick:()=>P(t),className:"p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":`Actions for request ${t.request_number}`,children:e.jsx(z,{className:"w-5 h-5 text-gray-500"})})})]},t.id)})})]})})]}),B&&r&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Update Buyback Request"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Request #",r.request_number]})]}),e.jsx("button",{onClick:h,className:"text-gray-400 hover:text-gray-600","aria-label":"Close edit modal",children:e.jsx(G,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"px-6 py-5 space-y-5",children:[S&&e.jsx("div",{className:"p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 text-sm",children:S}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("select",{value:o,onChange:t=>v(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"processing",children:"Processing"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsx("button",{onClick:h,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800",type:"button",children:"Cancel"}),e.jsx("button",{onClick:$,disabled:w,className:"px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",type:"button",children:w?"Saving...":"Save Changes"})]})]})})]})}export{Y as default};
